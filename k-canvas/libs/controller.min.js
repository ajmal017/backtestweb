function controller(b,a){this.canvas=$id(b);this.ctx=this.canvas.getContext("2d");this.region=a.region;this.bar=a.bar;this.value=a.value;this.minBarDistance=a.minBarDistance||5;this.onPositionChanged=a.onPositionChanged;this.prePaint=a.prePaint;this.isTouchDevice=isTouchDevice();this.touchFaultTolerance=a.touchFaultTolerance}controller.prototype={calcPositions:function(){var a=(this.region.width-this.bar.width);this.leftBarPosition=this.value.left*a/100+this.bar.width/2;this.rightBarPosition=this.value.right*a/100+this.bar.width/2},drawControllerPart:function(){var c=this.canvas;var a=this.ctx;a.save();var h=this.region;var f=this.bar;this.calcPositions();var e=this.leftBarPosition;var b=this.rightBarPosition;a.clearRect(h.x-1,h.y-1,h.width+1,h.height+1);if(typeof this.prePaint=="function"){this.prePaint(a)}a.lineWidth=1;a.strokeStyle=h.borderColor;a.beginPath();a.moveTo(h.x,h.y);a.lineTo(h.x,h.y+h.height);a.lineTo(h.x+e,h.y+h.height);a.lineTo(h.x+e,h.y+h.height-(h.height-f.height)/2);a.stroke();a.strokeStyle=h.borderColor;a.beginPath();a.moveTo(h.x+e,h.y+h.height/2-f.height/2);a.lineTo(h.x+e,h.y);a.lineTo(h.x,h.y);a.stroke();a.beginPath();a.moveTo(h.x+e,h.y+h.height);a.lineTo(h.x+h.width,h.y+h.height);a.lineTo(h.x+h.width,h.y);a.lineTo(h.x+b,h.y);a.lineTo(h.x+b,h.y+h.height/2-f.height/2);a.stroke();a.beginPath();a.moveTo(h.x+b,h.y+h.height/2+f.height/2);a.lineTo(h.x+b,h.y+h.height);a.stroke();a.beginPath();a.fillStyle="blue";a.globalAlpha=0.5;a.rect(h.x+e,h.y,b-e,h.height);a.closePath();a.fill();a.globalAlpha=1;a.strokeStyle=f.borderColor;a.fillStyle=f.fillColor;a.beginPath();var g={x:h.x+e-f.width/2,y:h.y+h.height/2-f.height/2,width:f.width,height:f.height};a.rect(g.x,g.y,g.width,g.height);this.leftBarRegion=g;a.closePath();a.stroke();a.fill();a.beginPath();var d={x:h.x+b-f.width/2,y:h.y+h.height/2-f.height/2,width:f.width,height:f.height};a.rect(d.x,d.y,d.width,d.height);this.rightBarRegion=d;a.closePath();a.stroke();a.fill();a.restore()},setLeftBarPosition:function(a){if(a<this.bar.width/2){this.leftBarPosition=this.bar.width/2}else{if(this.rightBarPosition-a-this.minBarDistance>this.bar.width){this.leftBarPosition=a}else{this.leftBarPosition=this.rightBarPosition-this.bar.width-this.minBarDistance}}this.value=this.getValue()},setRightBarPosition:function(a){if(a<this.leftBarPosition+this.bar.width+this.minBarDistance){this.rightBarPosition=this.leftBarPosition+this.bar.width+this.minBarDistance}else{if(a>this.region.width-this.bar.width/2){this.rightBarPosition=this.region.width-this.bar.width/2}else{this.rightBarPosition=a}}this.value=this.getValue()},addControllerEvents:function(){var c=this;if(c.isTouchDevice){var a=c.canvas;addEvent(a,"touchmove",function(o){o=o||event;var f=o.srcElement||o.target||o.relatedTarget;var n=o.touches;if(!n||!n.length){return}var l=false;var p=getPageCoord(this.canvas);if(c.fingers&&c.fingers.length){for(var m=0;m<c.fingers.length;m++){var q=c.fingers[m];for(var h=0;h<n.length;h++){var k=n[h];if(k.identifier==q.id){var g=k.pageX-p.x;var r=(g-q.startX);if(r!=0){if(q.type=="left"){c.setLeftBarPosition(q.leftPosition+r)}else{if(q.type=="right"){c.setRightBarPosition(q.rightPosition+r)}else{c.setLeftBarPosition(q.leftPosition+r);c.setRightBarPosition(q.rightPosition+r)}}l=true}break}}}}if(l){c.drawControllerPart();if(typeof c.onPositionChanged=="function"&&c.isValueChanged()){c.value=c.getValue();c.onPositionChanged(c.value)}}disableBubbleAndPreventDefault(o)});addEvent(a,"touchend",function(l){l=l||event;if(c.fingers&&c.fingers.length){if(typeof c.onPositionChanged=="function"&&c.isValueChanged()){c.value=c.getValue();c.onPositionChanged(c.value)}}else{var j=new Date().getTime()-c.touchstartTime.getTime();if(j<window.tapTimeLimit&&c.startTouch){var h=getPageCoord(c.canvas);var g=c.startTouch;var f={offsetX:g.pageX-h.x,offsetY:g.pageY-h.y};var k=(c.rightBarPosition+c.leftBarPosition)/2;var i=f.offsetX-k;c.setLeftBarPosition(c.leftBarPosition+i);c.setRightBarPosition(c.rightBarPosition+i);c.drawControllerPart();if(typeof c.onPositionChanged=="function"&&c.isValueChanged()){c.value=c.getValue();c.onPositionChanged(c.value)}c.startTouch=null}}c.fingers=null;disableBubbleAndPreventDefault(l)});addEvent(a,"touchstart",function(l){var j=l.touches;if(!j||!j.length){j=l.changedTouches}c.touchstartTime=new Date();c.startTouch=j[0];var f=l.srcElement||l.target||l.relatedTarget;var n=getPageCoord(c.canvas);function m(i){if(c.isOnLeftBar(i)){return"left"}if(c.isOnRightBar(i)){return"right"}if(c._isBetweenLeftAndRight(i)){return"middle"}return false}c.fingers=[];if(j.length){for(var h=0;h<j.length;h++){var g=j[h];var p={offsetX:g.pageX-n.x,offsetY:g.pageY-n.y};var k=m(p);if(!k){continue}var o={id:g.identifier,startX:g.pageX-n.x,type:k,leftPosition:c.leftBarPosition,rightPosition:c.rightBarPosition};c.fingers.push(o)}}disableBubbleAndPreventDefault(l);return false})}else{var e=function(i){var g=c.isOnLeftBar(i);var f=c.isOnRightBar(i);if(c._isBetweenLeftAndRight(i)){document.body.style.cursor="pointer"}else{if(g||f||c.triggerBar){document.body.style.cursor="col-resize"}else{document.body.style.cursor="default"}}if(c.triggerBar){c.triggerBar.targetX=i.offsetX;var h=(c.triggerBar.targetX-c.triggerBar.x);if(c.triggerBar.type=="left"){document.body.style.cursor="col-resize";c.setLeftBarPosition(c.triggerBar.position+h)}else{if(c.triggerBar.type=="right"){c.setRightBarPosition(c.triggerBar.position+h)}else{c.setLeftBarPosition(c.triggerBar.leftPosition+h);c.setRightBarPosition(c.triggerBar.rightPosition+h)}}if(typeof c.onPositionChanged=="function"&&c.isValueChanged()){c.value=c.getValue();c.onPositionChanged(c.value)}c.drawControllerPart()}};var b=function(f){if(c.triggerBar){}c.triggerBar=null;document.body.style.cursor="default";if(typeof c.onPositionChanged=="function"&&c.isValueChanged()){c.value=c.getValue();c.onPositionChanged(c.value)}};var d=function(i){var h=c.isOnLeftBar(i);var g=c.isOnRightBar(i);var f=c._isBetweenLeftAndRight(i);if(f){document.body.style.cursor="pointer"}else{if(h||g){document.body.style.cursor="col-resize"}else{document.body.style.cursor="default"}}if(h){c.triggerBar={type:"left",x:i.offsetX,position:c.leftBarPosition}}else{if(g){c.triggerBar={type:"right",x:i.offsetX,position:c.rightBarPosition}}else{if(f){c.triggerBar={type:"middle",x:i.offsetX,leftPosition:c.leftBarPosition,rightPosition:c.rightBarPosition}}else{c.triggerBar=null}}}};addEvent(c.canvas,"mouseup",b);addEvent(c.canvas,"mouseout",b);addEvent(c.canvas,"mousemove",function(g){g=g||event;if(g.preventDefault){g.preventDefault()}else{g.returnValue=false}var f=getOffset(g);e(f)});addEvent(c.canvas,"mousedown",function(g){g=g||event;var f=getOffset(g);d(f)})}},isValueChanged:function(){if(typeof this.preValue=="undefined"){this.preValue=this.getValue();return false}if(isTouchDevice()&&this.latestChangeTime){var b=new Date();if(b.getTime()-this.latestChangeTime.getTime()<50){return false}}var d=this.preValue;var c=this.getValue();var e=Math.abs(c.left-d.left)+Math.abs(c.right-d.right);this.preValue=c;var a=e!=0;if(a){this.latestChangeTime=new Date()}return e!=0},_isInRegion:function(a,b){return a.offsetX>b.x&&a.offsetX<b.x+b.width&&a.offsetY>b.y&&a.offsetY<b.y+b.height},_isBetweenLeftAndRight:function(b){var c=this.region;var a={x:c.x+this.leftBarPosition+this.bar.width/2,y:c.y,width:this.rightBarPosition-this.leftBarPosition-this.bar.width,height:this.region.height};return this._isInRegion(b,a)},_getTouchFaultToleranceRegion:function(b){var a=this;if(a.isTouchDevice){b.x-=a.touchFaultTolerance/2;b.width+=a.touchFaultTolerance/2}return b},isOnLeftBar:function(a){var b=this._getTouchFaultToleranceRegion(this.leftBarRegion);return this._isInRegion(a,b)},isOnRightBar:function(a){var b=this._getTouchFaultToleranceRegion(this.rightBarRegion);return this._isInRegion(a,b)},getValue:function(){var a=this.region.width-this.bar.width;return{left:(this.leftBarPosition-this.bar.width/2)*100/a,right:(this.rightBarPosition-this.bar.width/2)*100/a}}};