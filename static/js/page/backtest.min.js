"use strict";$(function(){var a="http://"+window.location.host+"/";var x=$(".wk-content").attr("data-type");var c=0;var g="";var j=0;var F=0;var s;var k=[];var H;var f;var e=0;var b=[];b[1]=0;b[3]=0;b[2]=0;b[4]=0;b[5]=0;var r=0;var q=0;var p=0;var n=0;var m=0;$(".wk-head-search").typeahead({minLength:1,maxItem:20,order:"asc",hint:true,group:true,maxItemPerGroup:null,backdrop:false,dynamic:true,filter:false,emptyTemplate:'未找到 "{{query}}" 的相关信息',display:["sentence"],source:{"热点事件":{ajax:{url:a+"ajax/backtest/ajax_search.php",data:{message:"{{query}}"},path:"events"}},"基本面":{ajax:{url:a+"ajax/backtest/ajax_search.php",data:{message:"{{query}}"},path:"basic"}},"技术面":{ajax:{url:a+"ajax/backtest/ajax_search.php",data:{message:"{{query}}"},path:"technology"}},"消息面":{ajax:{url:a+"ajax/backtest/ajax_search.php",data:{message:"{{query}}"},path:"news"}},"行为热度面":{ajax:{url:a+"ajax/backtest/ajax_search.php",data:{message:"{{query}}"},path:"hot"}}},callback:{onResult:function(){var M=$(".wk-head-search").val();var K=M.split("+");backtest.searchCheck({message:M},null,function(N){if(N.checked_sentences){if(N.checked_sentences.length!=K.length){$(".typeahead__result").css("display"," block")}else{$(".typeahead__result").css("display"," none")}}g=M});var L=y(M);if(L==1){$(".index_time .testfrom,.index_time .testto").attr({disabled:true})}else{$(".index_time .testfrom,.index_time .testto").attr({disabled:false})}},onClick:function(O,L,N,M){var K=$(".wk-head-search").val().split("+");K[K.length-1]=N.sentence;g=K.join("+");h(K,N.sentence)},onClickAfter:function(){$(".wk-head-search").val(g);G()},onSubmit:function(M,L,Q,K){var R=$(".index_time .testfrom").val();var P=$(".index_time .testto").val();var S=$(".wk-head-search").val();var N;var O;backtest.searchCheck({message:S},null,function(T){if(T.status==1){N=T.checked_sentences;if(R&&P){if(x!="result"){H=-1}if(H){backtest.backtest({search:JSON.stringify(N),base_sessionid:H,start_time:R,end_time:P},null,function(U){O=U.body.bt_session})}else{swal({title:"无筛选结果 ",type:"warning",timer:800,showConfirmButton:false})}}else{swal({title:"请选择回测时间",type:"warning",timer:800,showConfirmButton:false});$(".clock_time").trigger("click")}}else{if(T.result){swal({title:"搜索关键字为空 ",type:"warning",timer:600,showConfirmButton:false})}else{swal({title:"请输入正确的的回测关键词",type:"warning",timer:800,showConfirmButton:false})}}});setTimeout(function(){if(O){window.open(a+"backtest/result.php?session="+O,"_blank")}},500);return false}}});function y(L){var K=L.match(/\d{4}[-]\d{1,2}[-]\d{1,2}[-]\d{1,2}/);if(K==null){return false}else{return 1}}function E(){var L=J("session");var K=echarts.init(document.getElementById("wk-rate-line-pic"));backtest.getRateLine({sessionid:L},function(){$(".right_yield").hide()},function(M){if(M.body){if(M.body.list.length!=0){$(".right_yield").show()}common.buildRateLine("成分股","",M);K.hideLoading();s=1}else{s=0}})}$(".clock_time").on("click",function(){var K=$(".index_time").css("display");if(K=="block"){$(".index_time").hide()}else{$(".index_time").show()}$(document).bind("click",function(M){var L=$(M.target);if(L.closest(".typeahead__container").length==0){$(".index_time").hide()}})});$(".wk-head-search").mousemove(function(){var K=$(".typeahead__container").hasClass("cancel");if(!K){j=1}var L=$(".wk-head-search").val();if(!L){$(".index_recommend li").attr("data-type","0").removeClass("word_active")}});$(".wk-head-search").on("input propertychange",function(){var K=$(".wk-head-search").val().split("+");var L=K[K.length-1];h(K,L);G()});function h(L,O){var P=$(".right_condition li");var K=[];if(P.length){for(var M=0;M<P.length;M++){var Q=P.eq(M).text();K[M]=Q}L=K.concat(L)}for(var N=0;N<L.length-1;N++){if(O==L[N]){swal({title:"回测条件重复！",type:"warning",timer:1000,showConfirmButton:false});return false}}}function G(){var L=$(".wk-head-search").val();var N=t();if(L&&N){var M=L.split("+");var K;for(K in N){var O=N[K];if(z(O,M)){$(".index_recommend li[data-index='"+K+"']").addClass("word_active").attr("data-type","1")}else{$(".index_recommend li[data-index='"+K+"']").removeClass("word_active").attr("data-type","0")}}}}function t(){var N=$(".index_recommend li span,.left li span");var K=[];if(N.length){for(var M=0;M<N.length;M++){var O=N.eq(M).text();var L=N.eq(M).parent().data("index");K[L]=O}}return K}function A(){var L=Date.parse(new Date())-24*3600*1000;var K=Utility.unixToDate2(L);$(".index_time .testfrom").val(K);$(".index_time .testto").val(K);v("5","7","index-ul-new");v("1","7","index-ul-hot");v("2","7","index-ul-classic");B("1","","8","detail-ul-basic");B("3","","8","detail-ul-tec");B("2","","8","detail-ul-industry");B("4","","8","detail-ul-news");B("5","","8","detail-ul-events")}function u(){v("1","7","result-ul-hot");v("5","7","result-ul-new");v("2","7","result-ul-classic");$(".right_industry").append(common.getLoading());setTimeout(function(){E();D(0,10);l();$(".right_yield").removeClass("dis_none")},1000)}function z(L,M){for(var K in M){if(M[K]==L){return true}}return false}function J(K){var L=new RegExp("(^|&)"+K+"=([^&]*)(&|$)");var M=window.location.search.substr(1).match(L);if(M!=null){return unescape(M[2])}return null}function D(N,O){var M=J("session");var M=J("session");if(M){var K=[];var L=[];backtest.backtestResult({session:M,pos:N,count:O},function(){if(s){$(".dataload").html("<div class=\"wk-user-no\"><i class='fa fa-refresh fa-spin'></i>&nbsp;正在加载...</div>")}},function(R){console.log(R);if(!R.body.end_time){if(e>=10){window.open(a,"_self")}else{setTimeout(function(){f=1;D();E();e++},1000)}}else{if(f){N=0;f=0}$(".right_content_title,.table-responsive,.dataload").removeClass("dis_none");$(".right_industry").append(common.hideLoading());var Q=R.body.stocks;k=k.concat(Q);$(".testfrom").val(R.body.start_time);$(".testto").val(R.body.end_time);$(".right_stock_num span").html(R.body.count);if(R.body.right_sentence.length>0){var V;for(var S=0;S<R.body.right_sentence.length;S++){L.push("<li>"+R.body.right_sentence[S]+"</li>");if(V){V=V+"+"+R.body.right_sentence[S]}else{V=R.body.right_sentence[S]}}L.push('<div class="clear"></div>');$(".right_condition ul").html(L.join(""))}if(R.body.wrong_sentence.length){if(F==0){var U=[];var T=R.body.wrong_sentence.join(" , ");U.push("<ul class='wrongsentence' style='text-align: center;margin:0 auto'>");for(var P=0;P<R.body.wrong_sentence.length;P++){U.push("<li>"+R.body.wrong_sentence[P]+"</li>")}U.push("<div class='clear'></div> </ul>");swal({title:"以下条件不符合筛选规则",type:"warning",text:T,timer:1200,showConfirmButton:false},function(){window.open(a,"_self")});$(".sweet-alert p").html(U.join("")).parent().css("width","555px");F=1}}if(R.body.stocks.length){if(R.body.stocks.length==R.body.count){$(".right_resolve_data,.dataload").removeClass("dis_none");$(".dataload").addClass("dis_none")}for(var S=0;S<Q.length;S++){K.push("<tr>");K.push("<td>"+(S+N+1)+"</td>");K.push('<td><a href="http://stock.iwookong.com/ajax/login/nologin.php?stock='+Q[S].symbol+"&uid="+Q[S].uid+"&token="+Q[S].token+'" target="_blank">'+Q[S].symbol+"</a></td>");K.push("<td>"+Q[S].name+"</a></td>");K.push('<td class="'+Utility.getPriceColor(Q[S].changepercent)+'">'+Q[S].trade+"</td>");K.push('<td class=" '+Utility.getPriceColor(Q[S].changepercent)+'">'+Q[S].changepercent.toFixed(2)+"%</td>");K.push("<td>"+(Q[S].volume/10000).toFixed(2)+"万</td>");K.push("<td>"+Q[S].amount.toFixed(2)+"</td>");K.push("<td>"+Q[S].bordname+"</td></tr>");K.push("</tr>")}$(".right_industry_table tbody").append(K.join(""));$(".dataload").html('<div class="click_more">点击加载</div>');$("#table1 tbody").append(K.join(""));H=Utility.getUrlParam("session")}else{if(k.length){$(".right_resolve_data,.dataload").removeClass("dis_none");$(".dataload").addClass("dis_none")}else{$(".dataload").html("");$(".right_industry").html('<div style="width：100%;height:100px;line-height:100px;text-align:center"><img src="../../static/imgs/backtest/message.png" width="30px;">&nbsp;&nbsp;抱歉，没有选出相关的股票，请检查输入是否正确 </div>')}}}})}}function d(L){var M=L;var K=[];for(var N=0;N<M.length;N++){K.push("<tr>");K.push("<td>"+(N+1)+"</td>");K.push('<td><a href="http://stock.iwookong.com/ajax/login/nologin.php?stock='+M[N].symbol+"&uid="+M[N].uid+"&token="+M[N].token+'" target="_blank">'+M[N].symbol+"</a></td>");K.push("<td>"+M[N].name+"</a></td>");K.push('<td class="'+Utility.getPriceColor(M[N].changepercent)+'">'+M[N].trade+"</td>");K.push('<td class=" '+Utility.getPriceColor(M[N].changepercent)+'">'+M[N].changepercent.toFixed(2)+"%</td>");K.push("<td>"+(M[N].volume/10000).toFixed(2)+"万</td>");K.push("<td>"+M[N].amount.toFixed(2)+"</td>");K.push("<td>"+M[N].bordname+"</td></tr>");K.push("</tr>")}$(".right_industry_table tbody").html(K.join(""));$(".dataload").html('<div class="click_more">点击加载</div>');$("#table1 tbody").html(K.join(""))}function v(K,N,M){var L=[];backtest.getSentence({flag:K,count:N},function(){$("."+M).html("<div class='sentence_load'><i class='fa fa-refresh fa-spin'></i>&nbsp;正在加载...</div>")},function(O){console.log(O);if(O.head.status!=-103){if(O.body.sentences[0]){var Q=O.body.sentences[0][K];for(var P=0;P<Q.length;P++){if(K==1){}else{L.push('<li data-type="0" data-index="'+M+"-"+P+'"><span>'+Q[P].sentence+"</span></li>")}}$("."+M).find(".sentence_load").html("").removeClass("sentence_load");$("."+M).append(L.join(""))}else{$("."+M).html("<div style='text-align:center'>暂无数据</div>")}}})}function B(K,O,N,M){var L=[];backtest.getMoreSentence({flag:K,after_sentence:O,count:N},function(){$("."+M).append("<div class='sentence_load'><i class='fa fa-refresh fa-spin'></i>&nbsp;正在加载...</div>");$("."+M).next().hide()},function(P){if(P.head.status!=-103){if(P.body.sentences[0]){$("."+M).next().show();var R=P.body.sentences[0][K];b[K]=b[K]+R.length;for(var Q=0;Q<R.length;Q++){if(K==1){L.push('<li data-type="0" data-index="'+M+"-"+r+'"><span>'+R[Q].sentence+"</span></li>");r++}else{if(K==2){L.push('<li data-type="0" data-index="'+M+"-"+q+'"><span>'+R[Q].sentence+"</span></li>");q++}else{if(K==3){L.push('<li data-type="0" data-index="'+M+"-"+p+'"><span>'+R[Q].sentence+"</span></li>");p++}else{if(K==4){L.push('<li data-type="0" data-index="'+M+"-"+n+'"><span>'+R[Q].sentence+"</span></li>");n++}else{if(K==5){L.push('<li data-type="0" data-index="'+M+"-"+m+'"><span>'+R[Q].sentence+'</span><i class="fa tip_time">开始时间：'+Utility.unixToDate2(R[Q].create_time)+"，结束时间："+Utility.unixToDate2(R[Q].update)+"</i></li>");m++}}}}}}$("."+M).find(".sentence_load").html("").removeClass("sentence_load");$("."+M).find(".clear").before(L.join(""));if(P.body.sentences[0]["totals"]==b[K]){$("."+M).next().hide()}}else{$("."+M).html("<div style='text-align:center'>暂无数据</div>")}}})}$(".detail_type_more").on("click",function(){var L=$(this).attr("data-click-type");var M=$(this).prev().find("li span").last().html();var K=$(this).prev().attr("class");B(L,M,8,K)});function l(){$(window).scroll(function(){var N=$(this);var M=N.scrollTop();var L=$(document).height();var O=N.height();var K=L-M-O;if(K===0){c=c+10;D(c,10)}});$("body").on("click",".click_more",function(){c=c+10;D(c,10)})}function C(){var K=document.getElementById("export");K.addEventListener("click",function(L){L.preventDefault();tableExport("table1","回测平台",L.target.getAttribute("data-type"))},false)}var w="";$("body").on("click",".index_recommend li,.left li",function(){var M=$(this).attr("data-type");var N=$(this).find("span").html();var L=$(".wk-head-search").val();if(M==0){if(L==""){w=N}else{w=L+"+"+N}$(this).attr("data-type","1").addClass("word_active")}else{w=L;var K=w.split("+");K=$.grep(K,function(O){return O!=N});w=K.join("+");$(this).attr("data-type","0").removeClass("word_active");g=w}$(".wk-head-search").val(w);$(".wk-head-search").trigger("input")});$("body").on("click",".right thead td span",function(){var M;var L=$(this).attr("data-sort-type");var K=$(this).attr("data-hot-sort");if(L=="desc"){$(this).html("<img src='/static/imgs/i/icon_desc.png'>").attr("data-sort-type","ase").parent().siblings().find("span");M=k.sort(i(K))}else{$(this).html("<img src='/static/imgs/i/icon_asc.png'>").attr("data-sort-type","desc").parent().siblings().find("span");M=k.sort(I(K))}d(M)});var i=function(K){return function(O,N){var M,L;if(typeof O==="object"&&typeof N==="object"&&O&&N){M=O[K];L=N[K];if(M===L){return 0}if(typeof M===typeof L){return M>L?-1:1}return typeof M>typeof L?-1:1}else{throw ("error")}}};var I=function(K){return function(O,N){var M,L;if(typeof O==="object"&&typeof N==="object"&&O&&N){M=O[K];L=N[K];if(M===L){return 0}if(typeof M===typeof L){return M<L?-1:1}return typeof M<typeof L?-1:1}else{throw ("error")}}};$(".right .testfrom,.right .testto").on("focus",function(){var K=$(".right .testfrom").val();var L=$(".right .testto").val();$(".wk-header .testfrom").val(K);$(".wk-header .testto").val(L)});$(".index_more").on("click",function(){$(".detail_sentence").show();$(".index_sentence").hide()});$(".detail_back").on("click",function(){$(".index_sentence").show();$(".detail_sentence").hide()});$("body").on("mouseover",".index-ul-hot li,.result-ul-hot li,.detail-ul-events li",function(K){$(this).find("i").show()});$("body").on("mouseout",".index-ul-hot li,.result-ul-hot li,.detail-ul-events li",function(){$(this).find("i").hide()});function o(K){K=K||window.event;if(K.pageX||K.pageY){return{x:K.pageX,y:K.pageY}}return{x:K.clientX+document.body.scrollLeft-document.body.clientLeft,y:K.clientY+document.body.scrollTop-document.body.clientTop}}if(x=="result"){u();C()}else{A()}});