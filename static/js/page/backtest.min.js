"use strict";$(function(){var j="http://"+window.location.host+"/";var c=$(".wk-content").attr("data-type");var d=0;var b="";var l=0;var o=0;var s=0;var C;var t;var q=[];var g;var v;var a=0;$(".wk-head-search").typeahead({minLength:1,maxItem:20,order:"asc",hint:true,group:true,maxItemPerGroup:null,backdrop:false,dynamic:true,filter:false,emptyTemplate:'未找到 "{{query}}" 的相关信息',display:["sentence"],source:{"热点事件":{ajax:{url:j+"ajax/backtest/ajax_search.php",data:{message:"{{query}}"},path:"events"}},"基本面":{ajax:{url:j+"ajax/backtest/ajax_search.php",data:{message:"{{query}}"},path:"basic"}},"技术面":{ajax:{url:j+"ajax/backtest/ajax_search.php",data:{message:"{{query}}"},path:"technology"}},"消息面":{ajax:{url:j+"ajax/backtest/ajax_search.php",data:{message:"{{query}}"},path:"news"}},"行为热度面":{ajax:{url:j+"ajax/backtest/ajax_search.php",data:{message:"{{query}}"},path:"hot"}}},callback:{onResult:function(){var F=$(".wk-head-search").val();var D=F.split("+");backtest.searchCheck({message:F},null,function(G){if(G.checked_sentences){if(G.checked_sentences.length!=D.length){$(".typeahead__result").css("display"," block")}else{$(".typeahead__result").css("display"," none")}}b=F});var E=w(F);if(E==1){$(".index_time .testfrom,.index_time .testto").attr({disabled:true})}else{$(".index_time .testfrom,.index_time .testto").attr({disabled:false})}},onClick:function(H,E,G,F){var D=$(".wk-head-search").val().split("+");D[D.length-1]=G.sentence;b=D.join("+")},onClickAfter:function(){$(".wk-head-search").val(b)},onSubmit:function(F,E,J,D){var K=$(".index_time .testfrom").val();var I=$(".index_time .testto").val();var L=$(".wk-head-search").val();var G;var H;backtest.searchCheck({message:L},null,function(M){if(M.status==1){G=M.checked_sentences;if(K&&I){if(c!="result"){g=-1}if(g){backtest.backtest({search:JSON.stringify(G),base_sessionid:g,start_time:K,end_time:I},null,function(N){H=N.body.bt_session})}else{swal({title:"无筛选结果 ",type:"warning",timer:800,showConfirmButton:false})}}else{swal({title:"请选择回测时间",type:"warning",timer:800,showConfirmButton:false});$(".clock_time").trigger("click")}}else{if(M.result){swal({title:"搜索关键字为空 ",type:"warning",timer:600,showConfirmButton:false})}else{swal({title:"请输入正确的的回测关键词",type:"warning",timer:800,showConfirmButton:false})}}});setTimeout(function(){if(H){window.open(j+"backtest/result.php?session="+H,"_blank")}},500);return false}}});function w(E){var D=E.match(/\d{4}[-]\d{1,2}[-]\d{1,2}[-]\d{1,2}/);if(D==null){return false}else{return 1}}function i(){var E=h("session");var D=echarts.init(document.getElementById("wk-rate-line-pic"));backtest.getRateLine({sessionid:E},function(){$(".right_yield").hide()},function(F){if(F.body){if(F.body.list.length!=0){$(".right_yield").show()}common.buildRateLine("成分股","",F);D.hideLoading();C=1}else{C=0}})}$(".clock_time").on("click",function(){var D=$(".index_time").css("display");if(D=="block"){$(".index_time").hide()}else{$(".index_time").show()}$(document).bind("click",function(F){var E=$(F.target);if(E.closest(".typeahead__container").length==0){$(".index_time").hide()}})});$(".wk-head-search").mousemove(function(){var D=$(".typeahead__container").hasClass("cancel");if(!D){l=1}var E=$(".wk-head-search").val();if(!E){$(".index_recommend li").attr("data-type","0").removeClass("word_active")}});$(".wk-head-search").on("input propertychange",function(){f()});function f(){var E=$(".wk-head-search").val();var G=u();if(E&&G){var F=E.split("+");var D;for(D in G){var H=G[D];if(y(H,F)){$(".index_recommend li[data-index='"+D+"']").addClass("word_active").attr("data-type","1")}else{$(".index_recommend li[data-index='"+D+"']").removeClass("word_active").attr("data-type","0")}}}}function y(E,F){for(var D in F){if(F[D]==E){return true}}return false}function u(){var G=$(".index_recommend li,.left li");var D=[];if(G.length){for(var F=0;F<G.length;F++){var H=G.eq(F).text();var E=G.eq(F).data("index");D[E]=H}}return D}function z(){var E=Date.parse(new Date())-24*3600*1000;var D=Utility.unixToDate2(E);$(".index_time .testfrom").val(D);$(".index_time .testto").val(D);m("newHtml","5","7","index-ul-new");m("hotHtml","1","7","index-ul-hot");m("classicHtml","2","7","index-ul-classic")}function n(){m("hotHtml","1","7","result-ul-hot");m("newHtml","5","7","result-ul-new");m("classicHtml","2","7","result-ul-classic");$(".right_industry").append(common.getLoading());setTimeout(function(){i();r(0,10);x();$(".right_yield").removeClass("dis_none")},1000)}function y(E,F){for(var D in F){if(F[D]==E){return true}}return false}function h(D){var E=new RegExp("(^|&)"+D+"=([^&]*)(&|$)");var F=window.location.search.substr(1).match(E);if(F!=null){return unescape(F[2])}return null}function r(G,H){var F=h("session");if(F){var D=[];var E=[];backtest.backtestResult({session:F,pos:G,count:H},function(){if(C){$(".dataload").html("<div class=\"wk-user-no\"><i class='fa fa-refresh fa-spin'></i>&nbsp;正在加载...</div>")}},function(K){if(!K.body.end_time){if(a>=10){window.open(j,"_self")}else{setTimeout(function(){v=1;r();a++},1000)}}else{if(v){G=0;v=0}$(".right_content_title,.table-responsive,.dataload").removeClass("dis_none");$(".right_industry").append(common.hideLoading());var J=K.body.stocks;q=q.concat(J);$(".testfrom").val(K.body.start_time);$(".testto").val(K.body.end_time);$(".right_stock_num span").html(K.body.count);if(K.body.right_sentence.length>0){var O;for(var L=0;L<K.body.right_sentence.length;L++){E.push("<li>"+K.body.right_sentence[L]+"</li>");if(O){O=O+"+"+K.body.right_sentence[L]}else{O=K.body.right_sentence[L]}}E.push('<div class="clear"></div>');$(".right_condition ul").html(E.join(""))}if(K.body.wrong_sentence.length){if(s==0){var N=[];var M=K.body.wrong_sentence.join(" , ");N.push("<ul class='wrongsentence' style='text-align: center;margin:0 auto'>");for(var I=0;I<K.body.wrong_sentence.length;I++){N.push("<li>"+K.body.wrong_sentence[I]+"</li>")}N.push("<div class='clear'></div> </ul>");swal({title:"以下条件不符合筛选规则",type:"warning",text:M,timer:1200,showConfirmButton:false},function(){window.open(j,"_self")});$(".sweet-alert p").html(N.join("")).parent().css("width","555px");s=1}}if(K.body.stocks.length){if(K.body.stocks.length==K.body.count){$(".right_resolve_data,.dataload").removeClass("dis_none");$(".dataload").addClass("dis_none")}for(var L=0;L<J.length;L++){D.push("<tr><td>"+(L+G+1)+"</td><td>"+J[L].symbol+"</td><td>"+J[L].name+'</a></td><td class="'+Utility.getPriceColor(J[L].changepercent)+'">'+J[L].trade+'</td><td class=" '+Utility.getPriceColor(J[L].changepercent)+'">'+J[L].changepercent.toFixed(2)+"%</td><td>"+parseInt(J[L].volume/10000)+"万</td><td>"+J[L].amount.toFixed(2)+"</td><td>"+J[L].bordname+"</td></tr>")}$(".right_industry_table tbody").append(D.join(""));$(".dataload").html('<div class="click_more">点击加载</div>');$("#table1 tbody").append(D.join(""));g=Utility.getUrlParam("session")}else{if(q.length){$(".right_resolve_data,.dataload").removeClass("dis_none");$(".dataload").addClass("dis_none")}else{$(".dataload").html("");$(".right_industry").html('<div style="width：100%;height:100px;line-height:100px;text-align:center"><img src="../../static/imgs/backtest/message.png" width="30px;">&nbsp;&nbsp;抱歉，没有选出相关的股票，请检查输入是否正确 </div>')}}}})}}function k(E){var F=E;var D=[];for(var G=0;G<F.length;G++){D.push("<tr><td>"+(G+1)+"</td><td>"+F[G].symbol+"</td><td>"+F[G].name+'</a></td><td class="'+Utility.getPriceColor(F[G].changepercent)+'">'+F[G].trade+'</td><td class=" '+Utility.getPriceColor(F[G].changepercent)+'">'+F[G].changepercent.toFixed(2)+"%</td><td>"+parseInt(F[G].volume/10000)+"万</td><td>"+F[G].amount.toFixed(2)+"</td><td>"+F[G].bordname+"</td></tr>")}$(".right_industry_table tbody").html(D.join(""));$(".dataload").html('<div class="click_more">点击加载</div>');$("#table1 tbody").html(D.join(""))}function m(F,D,G,E){var F=[];backtest.getSentence({flag:D,count:G},function(){$("."+E).html("<div class='sentence_load'><i class='fa fa-refresh fa-spin'></i>&nbsp;正在加载...</div>")},function(H){if(H.head.status!=-103){if(H.body.sentences[0]){var J=H.body.sentences[0][D];for(var I=0;I<J.length;I++){F.push('<li data-type="0" data-index="'+E+"-"+I+'">'+J[I].sentence+"</li>")}$("."+E).html(F.join(""))}else{$("."+E).html("<div style='text-align:center'>暂无数据</div>")}}})}function x(){$(window).scroll(function(){var G=$(this);var F=G.scrollTop();var E=$(document).height();var H=G.height();var D=E-F-H;if(D===0){d=d+10;r(d,10)}});$("body").on("click",".click_more",function(){d=d+10;r(d,10)})}function A(){var D=document.getElementById("export");D.addEventListener("click",function(E){E.preventDefault();tableExport("table1","回测平台",E.target.getAttribute("data-type"))},false)}var e="";$("body").on("click",".index_recommend li,.left li",function(){var F=$(this).attr("data-type");var G=$(this).html();var E=$(".wk-head-search").val();if(F==0){if(E==""){e=G}else{e=E+"+"+G}$(this).attr("data-type","1").addClass("word_active");t=0}else{e=E;var D=e.split("+");D=$.grep(D,function(H){return H!=G});e=D.join("+");$(this).attr("data-type","0").removeClass("word_active");t=1;b=e}$(".wk-head-search").val(e);$(".wk-head-search").trigger("input")});$("body").on("click",".right thead td span",function(){var F;var E=$(this).attr("data-sort-type");var D=$(this).attr("data-hot-sort");if(E=="desc"){$(this).html("<img src='/static/imgs/i/icon_desc.png'>").attr("data-sort-type","ase").parent().siblings().find("span");F=q.sort(p(D))}else{$(this).html("<img src='/static/imgs/i/icon_asc.png'>").attr("data-sort-type","desc").parent().siblings().find("span");F=q.sort(B(D))}k(F)});var p=function(D){return function(H,G){var F,E;if(typeof H==="object"&&typeof G==="object"&&H&&G){F=H[D];E=G[D];if(F===E){return 0}if(typeof F===typeof E){return F>E?-1:1}return typeof F>typeof E?-1:1}else{throw ("error")}}};var B=function(D){return function(H,G){var F,E;if(typeof H==="object"&&typeof G==="object"&&H&&G){F=H[D];E=G[D];if(F===E){return 0}if(typeof F===typeof E){return F<E?-1:1}return typeof F<typeof E?-1:1}else{throw ("error")}}};$(".right .testfrom,.right .testto").on("focus",function(){var D=$(".right .testfrom").val();var E=$(".right .testto").val();$(".wk-header .testfrom").val(D);$(".wk-header .testto").val(E)});if(c=="result"){n();A()}else{z()}});