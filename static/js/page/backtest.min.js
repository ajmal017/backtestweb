"use strict";$(function(){var k="http://"+window.location.host+"/";var d=$(".wk-content").attr("data-type");var e=0;var c="";var m=0;var p=0;var t=0;var E;var u;var r=[];var h;var w;var a=0;var D=[];D[1]=0;D[3]=0;D[2]=0;D[4]=0;$(".wk-head-search").typeahead({minLength:1,maxItem:20,order:"asc",hint:true,group:true,maxItemPerGroup:null,backdrop:false,dynamic:true,filter:false,emptyTemplate:'未找到 "{{query}}" 的相关信息',display:["sentence"],source:{"热点事件":{ajax:{url:k+"ajax/backtest/ajax_search.php",data:{message:"{{query}}"},path:"events"}},"基本面":{ajax:{url:k+"ajax/backtest/ajax_search.php",data:{message:"{{query}}"},path:"basic"}},"技术面":{ajax:{url:k+"ajax/backtest/ajax_search.php",data:{message:"{{query}}"},path:"technology"}},"消息面":{ajax:{url:k+"ajax/backtest/ajax_search.php",data:{message:"{{query}}"},path:"news"}},"行为热度面":{ajax:{url:k+"ajax/backtest/ajax_search.php",data:{message:"{{query}}"},path:"hot"}}},callback:{onResult:function(){var H=$(".wk-head-search").val();var F=H.split("+");backtest.searchCheck({message:H},null,function(I){if(I.checked_sentences){if(I.checked_sentences.length!=F.length){$(".typeahead__result").css("display"," block")}else{$(".typeahead__result").css("display"," none")}}c=H});var G=x(H);if(G==1){$(".index_time .testfrom,.index_time .testto").attr({disabled:true})}else{$(".index_time .testfrom,.index_time .testto").attr({disabled:false})}},onClick:function(J,G,I,H){var F=$(".wk-head-search").val().split("+");F[F.length-1]=I.sentence;c=F.join("+")},onClickAfter:function(){$(".wk-head-search").val(c);g()},onSubmit:function(H,G,L,F){var M=$(".index_time .testfrom").val();var K=$(".index_time .testto").val();var N=$(".wk-head-search").val();var I;var J;backtest.searchCheck({message:N},null,function(O){if(O.status==1){I=O.checked_sentences;if(M&&K){if(d!="result"){h=-1}if(h){backtest.backtest({search:JSON.stringify(I),base_sessionid:h,start_time:M,end_time:K},null,function(P){J=P.body.bt_session})}else{swal({title:"无筛选结果 ",type:"warning",timer:800,showConfirmButton:false})}}else{swal({title:"请选择回测时间",type:"warning",timer:800,showConfirmButton:false});$(".clock_time").trigger("click")}}else{if(O.result){swal({title:"搜索关键字为空 ",type:"warning",timer:600,showConfirmButton:false})}else{swal({title:"请输入正确的的回测关键词",type:"warning",timer:800,showConfirmButton:false})}}});setTimeout(function(){if(J){window.open(k+"backtest/result.php?session="+J,"_blank")}},500);return false}}});function x(G){var F=G.match(/\d{4}[-]\d{1,2}[-]\d{1,2}[-]\d{1,2}/);if(F==null){return false}else{return 1}}function j(){var G=i("session");var F=echarts.init(document.getElementById("wk-rate-line-pic"));backtest.getRateLine({sessionid:G},function(){$(".right_yield").hide()},function(H){if(H.body){if(H.body.list.length!=0){$(".right_yield").show()}common.buildRateLine("成分股","",H);F.hideLoading();E=1}else{E=0}})}$(".clock_time").on("click",function(){var F=$(".index_time").css("display");if(F=="block"){$(".index_time").hide()}else{$(".index_time").show()}$(document).bind("click",function(H){var G=$(H.target);if(G.closest(".typeahead__container").length==0){$(".index_time").hide()}})});$(".wk-head-search").mousemove(function(){var F=$(".typeahead__container").hasClass("cancel");if(!F){m=1}var G=$(".wk-head-search").val();if(!G){$(".index_recommend li").attr("data-type","0").removeClass("word_active")}});$(".wk-head-search").on("input propertychange",function(){g()});function g(){var G=$(".wk-head-search").val();var I=v();if(G&&I){var H=G.split("+");var F;for(F in I){var J=I[F];if(z(J,H)){$(".index_recommend li[data-index='"+F+"']").addClass("word_active").attr("data-type","1")}else{$(".index_recommend li[data-index='"+F+"']").removeClass("word_active").attr("data-type","0")}}}}function z(G,H){for(var F in H){if(H[F]==G){return true}}return false}function v(){var I=$(".index_recommend li,.left li");var F=[];if(I.length){for(var H=0;H<I.length;H++){var J=I.eq(H).text();var G=I.eq(H).data("index");F[G]=J}}return F}function A(){var G=Date.parse(new Date())-24*3600*1000;var F=Utility.unixToDate2(G);$(".index_time .testfrom").val(F);$(".index_time .testto").val(F);n("5","7","index-ul-new");n("1","7","index-ul-hot");n("2","7","index-ul-classic");b("1","","8","detail-ul-basic");b("3","","8","detail-ul-tec");b("2","","8","detail-ul-industry");b("4","","8","detail-ul-news")}function o(){n("1","7","result-ul-hot");n("5","7","result-ul-new");n("2","7","result-ul-classic");$(".right_industry").append(common.getLoading());setTimeout(function(){j();s(0,10);y();$(".right_yield").removeClass("dis_none")},1000)}function z(G,H){for(var F in H){if(H[F]==G){return true}}return false}function i(F){var G=new RegExp("(^|&)"+F+"=([^&]*)(&|$)");var H=window.location.search.substr(1).match(G);if(H!=null){return unescape(H[2])}return null}function s(I,J){var H=i("session");if(H){var F=[];var G=[];backtest.backtestResult({session:H,pos:I,count:J},function(){if(E){$(".dataload").html("<div class=\"wk-user-no\"><i class='fa fa-refresh fa-spin'></i>&nbsp;正在加载...</div>")}},function(M){if(!M.body.end_time){if(a>=10){window.open(k,"_self")}else{setTimeout(function(){w=1;s();j();a++},1000)}}else{if(w){I=0;w=0}$(".right_content_title,.table-responsive,.dataload").removeClass("dis_none");$(".right_industry").append(common.hideLoading());var L=M.body.stocks;r=r.concat(L);$(".testfrom").val(M.body.start_time);$(".testto").val(M.body.end_time);$(".right_stock_num span").html(M.body.count);if(M.body.right_sentence.length>0){var Q;for(var N=0;N<M.body.right_sentence.length;N++){G.push("<li>"+M.body.right_sentence[N]+"</li>");if(Q){Q=Q+"+"+M.body.right_sentence[N]}else{Q=M.body.right_sentence[N]}}G.push('<div class="clear"></div>');$(".right_condition ul").html(G.join(""))}if(M.body.wrong_sentence.length){if(t==0){var P=[];var O=M.body.wrong_sentence.join(" , ");P.push("<ul class='wrongsentence' style='text-align: center;margin:0 auto'>");for(var K=0;K<M.body.wrong_sentence.length;K++){P.push("<li>"+M.body.wrong_sentence[K]+"</li>")}P.push("<div class='clear'></div> </ul>");swal({title:"以下条件不符合筛选规则",type:"warning",text:O,timer:1200,showConfirmButton:false},function(){window.open(k,"_self")});$(".sweet-alert p").html(P.join("")).parent().css("width","555px");t=1}}if(M.body.stocks.length){if(M.body.stocks.length==M.body.count){$(".right_resolve_data,.dataload").removeClass("dis_none");$(".dataload").addClass("dis_none")}for(var N=0;N<L.length;N++){F.push("<tr><td>"+(N+I+1)+"</td><td>"+L[N].symbol+"</td><td>"+L[N].name+'</a></td><td class="'+Utility.getPriceColor(L[N].changepercent)+'">'+L[N].trade+'</td><td class=" '+Utility.getPriceColor(L[N].changepercent)+'">'+L[N].changepercent.toFixed(2)+"%</td><td>"+parseInt(L[N].volume/10000)+"万</td><td>"+L[N].amount.toFixed(2)+"</td><td>"+L[N].bordname+"</td></tr>")}$(".right_industry_table tbody").append(F.join(""));$(".dataload").html('<div class="click_more">点击加载</div>');$("#table1 tbody").append(F.join(""));h=Utility.getUrlParam("session")}else{if(r.length){$(".right_resolve_data,.dataload").removeClass("dis_none");$(".dataload").addClass("dis_none")}else{$(".dataload").html("");$(".right_industry").html('<div style="width：100%;height:100px;line-height:100px;text-align:center"><img src="../../static/imgs/backtest/message.png" width="30px;">&nbsp;&nbsp;抱歉，没有选出相关的股票，请检查输入是否正确 </div>')}}}})}}function l(G){var H=G;var F=[];for(var I=0;I<H.length;I++){F.push("<tr><td>"+(I+1)+"</td><td>"+H[I].symbol+"</td><td>"+H[I].name+'</a></td><td class="'+Utility.getPriceColor(H[I].changepercent)+'">'+H[I].trade+'</td><td class=" '+Utility.getPriceColor(H[I].changepercent)+'">'+H[I].changepercent.toFixed(2)+"%</td><td>"+parseInt(H[I].volume/10000)+"万</td><td>"+H[I].amount.toFixed(2)+"</td><td>"+H[I].bordname+"</td></tr>")}$(".right_industry_table tbody").html(F.join(""));$(".dataload").html('<div class="click_more">点击加载</div>');$("#table1 tbody").html(F.join(""))}function n(F,I,H){var G=[];backtest.getSentence({flag:F,count:I},function(){$("."+H).html("<div class='sentence_load'><i class='fa fa-refresh fa-spin'></i>&nbsp;正在加载...</div>")},function(J){if(J.head.status!=-103){if(J.body.sentences[0]){var L=J.body.sentences[0][F];for(var K=0;K<L.length;K++){G.push('<li data-type="0" data-index="'+H+"-"+K+'">'+L[K].sentence+"</li>")}$("."+H).find(".sentence_load").html("").removeClass("sentence_load");$("."+H).append(G.join(""))}else{$("."+H).html("<div style='text-align:center'>暂无数据</div>")}}})}function b(F,J,I,H){var G=[];backtest.getMoreSentence({flag:F,after_sentence:J,count:I},function(){$("."+H).append("<div class='sentence_load'><i class='fa fa-refresh fa-spin'></i>&nbsp;正在加载...</div>");$("."+H).next().hide()},function(K){if(K.head.status!=-103){if(K.body.sentences[0]){$("."+H).next().show();var M=K.body.sentences[0][F];D[F]=D[F]+M.length;for(var L=0;L<M.length;L++){G.push('<li data-type="0" data-index="'+H+"-"+L+'">'+M[L].sentence+"</li>")}$("."+H).find(".sentence_load").html("").removeClass("sentence_load");$("."+H).find(".clear").before(G.join(""));if(K.body.sentences[0]["totals"]==D[F]){$("."+H).next().hide()}}else{$("."+H).html("<div style='text-align:center'>暂无数据</div>")}}})}$(".detail_type_more").on("click",function(){var G=$(this).attr("data-click-type");var H=$(this).prev().find("li").last().html();var F=$(this).prev().attr("class");b(G,H,8,F)});function y(){$(window).scroll(function(){var I=$(this);var H=I.scrollTop();var G=$(document).height();var J=I.height();var F=G-H-J;if(F===0){e=e+10;s(e,10)}});$("body").on("click",".click_more",function(){e=e+10;s(e,10)})}function B(){var F=document.getElementById("export");F.addEventListener("click",function(G){G.preventDefault();tableExport("table1","回测平台",G.target.getAttribute("data-type"))},false)}var f="";$("body").on("click",".index_recommend li,.left li",function(){var H=$(this).attr("data-type");var I=$(this).html();var G=$(".wk-head-search").val();if(H==0){if(G==""){f=I}else{f=G+"+"+I}$(this).attr("data-type","1").addClass("word_active");u=0}else{f=G;var F=f.split("+");F=$.grep(F,function(J){return J!=I});f=F.join("+");$(this).attr("data-type","0").removeClass("word_active");u=1;c=f}$(".wk-head-search").val(f);$(".wk-head-search").trigger("input")});$("body").on("click",".right thead td span",function(){var H;var G=$(this).attr("data-sort-type");var F=$(this).attr("data-hot-sort");if(G=="desc"){$(this).html("<img src='/static/imgs/i/icon_desc.png'>").attr("data-sort-type","ase").parent().siblings().find("span");H=r.sort(q(F))}else{$(this).html("<img src='/static/imgs/i/icon_asc.png'>").attr("data-sort-type","desc").parent().siblings().find("span");H=r.sort(C(F))}l(H)});var q=function(F){return function(J,I){var H,G;if(typeof J==="object"&&typeof I==="object"&&J&&I){H=J[F];G=I[F];if(H===G){return 0}if(typeof H===typeof G){return H>G?-1:1}return typeof H>typeof G?-1:1}else{throw ("error")}}};var C=function(F){return function(J,I){var H,G;if(typeof J==="object"&&typeof I==="object"&&J&&I){H=J[F];G=I[F];if(H===G){return 0}if(typeof H===typeof G){return H<G?-1:1}return typeof H<typeof G?-1:1}else{throw ("error")}}};$(".right .testfrom,.right .testto").on("focus",function(){var F=$(".right .testfrom").val();var G=$(".right .testto").val();$(".wk-header .testfrom").val(F);$(".wk-header .testto").val(G)});$(".index_more").on("click",function(){$(".detail_sentence").show();$(".index_sentence").hide()});$(".detail_back").on("click",function(){$(".index_sentence").show();$(".detail_sentence").hide()});if(d=="result"){o();B()}else{A()}});