"use strict";$(function(){var k="http://"+window.location.host+"/";var d=$(".wk-content").attr("data-type");var e=0;var c="";var m=0;var s=0;var E;var q=[];var h;var u;var a=0;var C=[];C[1]=0;C[3]=0;C[2]=0;C[4]=0;var H=0;var G=0;var F=0;var D=0;var B=0;$(".wk-head-search").typeahead({minLength:1,maxItem:20,order:"asc",hint:true,group:true,maxItemPerGroup:null,backdrop:false,dynamic:true,filter:false,emptyTemplate:'未找到 "{{query}}" 的相关信息',display:["sentence"],source:{"热点事件":{ajax:{url:k+"ajax/backtest/ajax_search.php",data:{message:"{{query}}"},path:"events"}},"基本面":{ajax:{url:k+"ajax/backtest/ajax_search.php",data:{message:"{{query}}"},path:"basic"}},"技术面":{ajax:{url:k+"ajax/backtest/ajax_search.php",data:{message:"{{query}}"},path:"technology"}},"消息面":{ajax:{url:k+"ajax/backtest/ajax_search.php",data:{message:"{{query}}"},path:"news"}},"行为热度面":{ajax:{url:k+"ajax/backtest/ajax_search.php",data:{message:"{{query}}"},path:"hot"}}},callback:{onResult:function(){var K=$(".wk-head-search").val();var I=K.split("+");backtest.searchCheck({message:K},null,function(L){if(L.checked_sentences){if(L.checked_sentences.length!=I.length){$(".typeahead__result").css("display"," block")}else{$(".typeahead__result").css("display"," none")}}c=K});var J=v(K);if(J==1){$(".index_time .testfrom,.index_time .testto").attr({disabled:true})}else{$(".index_time .testfrom,.index_time .testto").attr({disabled:false})}},onClick:function(M,J,L,K){var I=$(".wk-head-search").val().split("+");I[I.length-1]=L.sentence;c=I.join("+")},onClickAfter:function(){$(".wk-head-search").val(c);g()},onSubmit:function(K,J,O,I){var P=$(".index_time .testfrom").val();var N=$(".index_time .testto").val();var Q=$(".wk-head-search").val();var L;var M;backtest.searchCheck({message:Q},null,function(R){if(R.status==1){L=R.checked_sentences;if(P&&N){if(d!="result"){h=-1}if(h){backtest.backtest({search:JSON.stringify(L),base_sessionid:h,start_time:P,end_time:N},null,function(S){M=S.body.bt_session})}else{swal({title:"无筛选结果 ",type:"warning",timer:800,showConfirmButton:false})}}else{swal({title:"请选择回测时间",type:"warning",timer:800,showConfirmButton:false});$(".clock_time").trigger("click")}}else{if(R.result){swal({title:"搜索关键字为空 ",type:"warning",timer:600,showConfirmButton:false})}else{swal({title:"请输入正确的的回测关键词",type:"warning",timer:800,showConfirmButton:false})}}});setTimeout(function(){if(M){window.open(k+"backtest/result.php?session="+M,"_blank")}},500);return false}}});function v(J){var I=J.match(/\d{4}[-]\d{1,2}[-]\d{1,2}[-]\d{1,2}/);if(I==null){return false}else{return 1}}function j(){var J=i("session");var I=echarts.init(document.getElementById("wk-rate-line-pic"));backtest.getRateLine({sessionid:J},function(){$(".right_yield").hide()},function(K){if(K.body){if(K.body.list.length!=0){$(".right_yield").show()}common.buildRateLine("成分股","",K);I.hideLoading();E=1}else{E=0}})}$(".clock_time").on("click",function(){var I=$(".index_time").css("display");if(I=="block"){$(".index_time").hide()}else{$(".index_time").show()}$(document).bind("click",function(K){var J=$(K.target);if(J.closest(".typeahead__container").length==0){$(".index_time").hide()}})});$(".wk-head-search").mousemove(function(){var I=$(".typeahead__container").hasClass("cancel");if(!I){m=1}var J=$(".wk-head-search").val();if(!J){$(".index_recommend li").attr("data-type","0").removeClass("word_active")}});$(".wk-head-search").on("input propertychange",function(){g()});function g(){var J=$(".wk-head-search").val();var L=t();if(J&&L){var K=J.split("+");var I;for(I in L){var M=L[I];if(x(M,K)){$(".index_recommend li[data-index='"+I+"']").addClass("word_active").attr("data-type","1")}else{$(".index_recommend li[data-index='"+I+"']").removeClass("word_active").attr("data-type","0")}}}}function x(J,K){for(var I in K){if(K[I]==J){return true}}return false}function t(){var L=$(".index_recommend li span,.left li span");var I=[];if(L.length){for(var K=0;K<L.length;K++){var M=L.eq(K).text();var J=L.eq(K).parent().data("index");I[J]=M}}return I}function y(){var J=Date.parse(new Date())-24*3600*1000;var I=Utility.unixToDate2(J);$(".index_time .testfrom").val(I);$(".index_time .testto").val(I);n("5","7","index-ul-new");n("1","7","index-ul-hot");n("2","7","index-ul-classic");b("1","","8","detail-ul-basic");b("3","","8","detail-ul-tec");b("2","","8","detail-ul-industry");b("4","","8","detail-ul-news");b("5","","8","detail-ul-events")}function o(){n("1","7","result-ul-hot");n("5","7","result-ul-new");n("2","7","result-ul-classic");$(".right_industry").append(common.getLoading());setTimeout(function(){j();r(0,10);w();$(".right_yield").removeClass("dis_none")},1000)}function x(J,K){for(var I in K){if(K[I]==J){return true}}return false}function i(I){var J=new RegExp("(^|&)"+I+"=([^&]*)(&|$)");var K=window.location.search.substr(1).match(J);if(K!=null){return unescape(K[2])}return null}function r(L,M){var K=i("session");var K=i("session");if(K){var I=[];var J=[];backtest.backtestResult({session:K,pos:L,count:M},function(){if(E){$(".dataload").html("<div class=\"wk-user-no\"><i class='fa fa-refresh fa-spin'></i>&nbsp;正在加载...</div>")}},function(P){console.log(P);if(!P.body.end_time){if(a>=10){window.open(k,"_self")}else{setTimeout(function(){u=1;r();j();a++},1000)}}else{if(u){L=0;u=0}$(".right_content_title,.table-responsive,.dataload").removeClass("dis_none");$(".right_industry").append(common.hideLoading());var O=P.body.stocks;q=q.concat(O);$(".testfrom").val(P.body.start_time);$(".testto").val(P.body.end_time);$(".right_stock_num span").html(P.body.count);if(P.body.right_sentence.length>0){var T;for(var Q=0;Q<P.body.right_sentence.length;Q++){J.push("<li>"+P.body.right_sentence[Q]+"</li>");if(T){T=T+"+"+P.body.right_sentence[Q]}else{T=P.body.right_sentence[Q]}}J.push('<div class="clear"></div>');$(".right_condition ul").html(J.join(""))}if(P.body.wrong_sentence.length){if(s==0){var S=[];var R=P.body.wrong_sentence.join(" , ");S.push("<ul class='wrongsentence' style='text-align: center;margin:0 auto'>");for(var N=0;N<P.body.wrong_sentence.length;N++){S.push("<li>"+P.body.wrong_sentence[N]+"</li>")}S.push("<div class='clear'></div> </ul>");swal({title:"以下条件不符合筛选规则",type:"warning",text:R,timer:1200,showConfirmButton:false},function(){window.open(k,"_self")});$(".sweet-alert p").html(S.join("")).parent().css("width","555px");s=1}}if(P.body.stocks.length){if(P.body.stocks.length==P.body.count){$(".right_resolve_data,.dataload").removeClass("dis_none");$(".dataload").addClass("dis_none")}for(var Q=0;Q<O.length;Q++){I.push("<tr><td>"+(Q+L+1)+'</td><td><a href="http://t.stock.iwookong.com/ajax/login/nologin.php?stock='+O[Q].symbol+"&uid="+O[Q].uid+"&token="+O[Q].token+'" target="_blank">'+O[Q].symbol+"</a></td><td>"+O[Q].name+'</a></td><td class="'+Utility.getPriceColor(O[Q].changepercent)+'">'+O[Q].trade+'</td><td class=" '+Utility.getPriceColor(O[Q].changepercent)+'">'+O[Q].changepercent.toFixed(2)+"%</td><td>"+parseInt(O[Q].volume/10000)+"万</td><td>"+O[Q].amount.toFixed(2)+"</td><td>"+O[Q].bordname+"</td></tr>")}$(".right_industry_table tbody").append(I.join(""));$(".dataload").html('<div class="click_more">点击加载</div>');$("#table1 tbody").append(I.join(""));h=Utility.getUrlParam("session")}else{if(q.length){$(".right_resolve_data,.dataload").removeClass("dis_none");$(".dataload").addClass("dis_none")}else{$(".dataload").html("");$(".right_industry").html('<div style="width：100%;height:100px;line-height:100px;text-align:center"><img src="../../static/imgs/backtest/message.png" width="30px;">&nbsp;&nbsp;抱歉，没有选出相关的股票，请检查输入是否正确 </div>')}}}})}}function l(J){var K=J;console.log(K);var I=[];for(var L=0;L<K.length;L++){I.push("<tr><td>"+(L+1)+'</td><td><a href="http://t.stock.iwookong.com/ajax/login/nologin.php?stock='+K[L].symbol+"&uid="+K[L].uid+"&token="+K[L].token+'" target="_blank">'+K[L].symbol+"</a></td><td>"+K[L].name+'</a></td><td class="'+Utility.getPriceColor(K[L].changepercent)+'">'+K[L].trade+'</td><td class=" '+Utility.getPriceColor(K[L].changepercent)+'">'+K[L].changepercent.toFixed(2)+"%</td><td>"+parseInt(K[L].volume/10000)+"万</td><td>"+K[L].amount.toFixed(2)+"</td><td>"+K[L].bordname+"</td></tr>")}$(".right_industry_table tbody").html(I.join(""));$(".dataload").html('<div class="click_more">点击加载</div>');$("#table1 tbody").html(I.join(""))}function n(I,L,K){var J=[];backtest.getSentence({flag:I,count:L},function(){$("."+K).html("<div class='sentence_load'><i class='fa fa-refresh fa-spin'></i>&nbsp;正在加载...</div>")},function(M){if(M.head.status!=-103){if(M.body.sentences[0]){var O=M.body.sentences[0][I];for(var N=0;N<O.length;N++){if(I==1){J.push('<li data-type="0" data-index="'+K+"-"+N+'"><span>'+O[N].sentence+'</span><i class="fa tip_time">开始时间：'+Utility.unixToDate2(O[N].create_time)+"，结束时间："+Utility.unixToDate2(O[N].end_time)+"</i></li>")}else{J.push('<li data-type="0" data-index="'+K+"-"+N+'"><span>'+O[N].sentence+"</span></li>")}}$("."+K).find(".sentence_load").html("").removeClass("sentence_load");$("."+K).append(J.join(""))}else{$("."+K).html("<div style='text-align:center'>暂无数据</div>")}}})}function b(I,M,L,K){var J=[];backtest.getMoreSentence({flag:I,after_sentence:M,count:L},function(){$("."+K).append("<div class='sentence_load'><i class='fa fa-refresh fa-spin'></i>&nbsp;正在加载...</div>");$("."+K).next().hide()},function(N){if(N.head.status!=-103){if(N.body.sentences[0]){$("."+K).next().show();var P=N.body.sentences[0][I];C[I]=C[I]+P.length;for(var O=0;O<P.length;O++){if(I==1){J.push('<li data-type="0" data-index="'+K+"-"+H+'"><span>'+P[O].sentence+"</span></li>");H++}else{if(I==2){J.push('<li data-type="0" data-index="'+K+"-"+G+'"><span>'+P[O].sentence+"</span></li>");G++}else{if(I==3){J.push('<li data-type="0" data-index="'+K+"-"+F+'"><span>'+P[O].sentence+"</span></li>");F++}else{if(I==4){J.push('<li data-type="0" data-index="'+K+"-"+D+'"><span>'+P[O].sentence+"</span></li>");D++}else{if(I==5){J.push('<li data-type="0" data-index="'+K+"-"+B+'"><span>'+P[O].sentence+"</span></li>");B++}}}}}}$("."+K).find(".sentence_load").html("").removeClass("sentence_load");$("."+K).find(".clear").before(J.join(""));if(N.body.sentences[0]["totals"]==C[I]){$("."+K).next().hide()}}else{$("."+K).html("<div style='text-align:center'>暂无数据</div>")}}})}$(".detail_type_more").on("click",function(){var J=$(this).attr("data-click-type");var K=$(this).prev().find("li span").last().html();var I=$(this).prev().attr("class");b(J,K,8,I)});function w(){$(window).scroll(function(){var L=$(this);var K=L.scrollTop();var J=$(document).height();var M=L.height();var I=J-K-M;if(I===0){e=e+10;r(e,10)}});$("body").on("click",".click_more",function(){e=e+10;r(e,10)})}function z(){var I=document.getElementById("export");I.addEventListener("click",function(J){J.preventDefault();tableExport("table1","回测平台",J.target.getAttribute("data-type"))},false)}var f="";$("body").on("click",".index_recommend li,.left li",function(){var K=$(this).attr("data-type");var L=$(this).find("span").html();var J=$(".wk-head-search").val();if(K==0){if(J==""){f=L}else{f=J+"+"+L}$(this).attr("data-type","1").addClass("word_active")}else{f=J;var I=f.split("+");I=$.grep(I,function(M){return M!=L});f=I.join("+");$(this).attr("data-type","0").removeClass("word_active");c=f}$(".wk-head-search").val(f);$(".wk-head-search").trigger("input")});$("body").on("click",".right thead td span",function(){var K;var J=$(this).attr("data-sort-type");var I=$(this).attr("data-hot-sort");if(J=="desc"){$(this).html("<img src='/static/imgs/i/icon_desc.png'>").attr("data-sort-type","ase").parent().siblings().find("span");K=q.sort(p(I))}else{$(this).html("<img src='/static/imgs/i/icon_asc.png'>").attr("data-sort-type","desc").parent().siblings().find("span");K=q.sort(A(I))}l(K)});var p=function(I){return function(M,L){var K,J;if(typeof M==="object"&&typeof L==="object"&&M&&L){K=M[I];J=L[I];if(K===J){return 0}if(typeof K===typeof J){return K>J?-1:1}return typeof K>typeof J?-1:1}else{throw ("error")}}};var A=function(I){return function(M,L){var K,J;if(typeof M==="object"&&typeof L==="object"&&M&&L){K=M[I];J=L[I];if(K===J){return 0}if(typeof K===typeof J){return K<J?-1:1}return typeof K<typeof J?-1:1}else{throw ("error")}}};$(".right .testfrom,.right .testto").on("focus",function(){var I=$(".right .testfrom").val();var J=$(".right .testto").val();$(".wk-header .testfrom").val(I);$(".wk-header .testto").val(J)});$(".index_more").on("click",function(){$(".detail_sentence").show();$(".index_sentence").hide()});$(".detail_back").on("click",function(){$(".index_sentence").show();$(".detail_sentence").hide()});$("body").on("mouseover",".index-ul-hot li,.result-ul-hot li",function(){$(this).find("i").show()});$("body").on("mouseout",".index-ul-hot li,.result-ul-hot li",function(){$(this).find("i").hide()});if(d=="result"){o();z()}else{y()}});