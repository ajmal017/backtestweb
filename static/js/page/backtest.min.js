"use strict";$(function(){var m="http://"+window.location.host+"/";var e=$(".wk-content").attr("data-type");var f=0;var d="";var o=0;var t=0;var F;var r=[];var k;var w;var b=0;var D=[];D[1]=0;D[3]=0;D[2]=0;D[4]=0;D[5]=0;D[6]=0;var I=0;var H=0;var G=0;var E=0;var C=0;var B=0;var v=Date.parse(new Date())-24*3600*1000;var j=Utility.unixToDate2(v);var g=Utility.unixToDate3(v);$(".wk-head-search").typeahead({minLength:1,maxItem:20,order:"asc",hint:true,group:true,maxItemPerGroup:null,backdrop:false,dynamic:true,filter:false,emptyTemplate:'未找到 "{{query}}" 的相关信息',display:["sentence"],source:{"热点事件":{ajax:{url:m+"ajax/backtest/ajax_search.php",data:{message:"{{query}}"},path:"events"}},"基本面":{ajax:{url:m+"ajax/backtest/ajax_search.php",data:{message:"{{query}}"},path:"basic"}},"技术面":{ajax:{url:m+"ajax/backtest/ajax_search.php",data:{message:"{{query}}"},path:"technology"}},"消息面":{ajax:{url:m+"ajax/backtest/ajax_search.php",data:{message:"{{query}}"},path:"news"}},"行为热度面":{ajax:{url:m+"ajax/backtest/ajax_search.php",data:{message:"{{query}}"},path:"hot"}}},callback:{onResult:function(){var K=$(".wk-head-search").val();var J=K.split("+");backtest.searchCheck({message:K},null,function(L){if(L.checked_sentences){if(L.checked_sentences.length!=J.length){$(".typeahead__result").css("display"," block")}else{$(".typeahead__result").css("display"," none")}}if(L.status){var O=L.checked_sentences;var N=0;for(var M=0;M<O.length;M++){if(19000<=O[M]["id"]&&O[M]["id"]<20000){N=1}}if(N){$(".index_time .testfrom,.index_time .testto").val(g);$(".testfrom,.testto").attr("onFocus","WdatePicker({lang:'zh-cn',dateFmt:'yyyy-MM-dd-HH',maxDate:'time_h'})")}else{$(".index_time .testfrom,.index_time .testto").val(j);$(".testfrom,.testto").attr("onFocus","WdatePicker({lang:'zh-cn',dateFmt:'yyyy-MM-dd',maxDate:new Date()})")}}d=K})},onClick:function(M,K,L){var J=$(".wk-head-search").val().split("+");J[J.length-1]=L.sentence;d=J.join("+");a(J,L.sentence)},onClickAfter:function(){$(".wk-head-search").val(d);i()},onSubmit:function(L,K,P,J){var Q=$(".index_time .testfrom").val();var O=$(".index_time .testto").val();var R=$(".wk-head-search").val();var M;var N;backtest.searchCheck({message:R},null,function(S){if(S.status==1){M=S.checked_sentences;if(Q&&O){if(e!="result"){k=-1}if(k){backtest.backtest({search:JSON.stringify(M),base_sessionid:k,start_time:Q,end_time:O},null,function(T){N=T.body.bt_session})}else{swal({title:"无筛选结果 ",type:"warning",timer:800,showConfirmButton:false})}}else{swal({title:"请选择回测时间",type:"warning",timer:800,showConfirmButton:false});$(".clock_time").trigger("click")}}else{if(S.result){swal({title:"搜索关键字为空 ",type:"warning",timer:600,showConfirmButton:false})}else{swal({title:"请输入正确的的回测关键词",type:"warning",timer:800,showConfirmButton:false})}}});setTimeout(function(){if(N){window.open(m+"backtest/result.php?session="+N,"_blank")}},500);return false}}});function l(){var K=Utility.getUrlParam("session");var J=echarts.init(document.getElementById("wk-rate-line-pic"));backtest.getRateLine({sessionid:K},function(){$(".right_yield").hide()},function(L){if(L.body){if(L.body.list.length!=0){$(".right_yield").show()}common.buildRateLine("成分股","",L);J.hideLoading();F=1}else{F=0}})}$(".clock_time").on("click",function(){var J=$(".index_time").css("display");if(J=="block"){$(".index_time").hide()}else{$(".index_time").show()}$(document).bind("click",function(L){var K=$(L.target);if(K.closest(".typeahead__container").length==0){$(".index_time").hide()}})});$(".wk-head-search").mousemove(function(){var J=$(".typeahead__container").hasClass("cancel");if(!J){o=1}var K=$(".wk-head-search").val();if(!K){$(".index_recommend li").attr("data-type","0").removeClass("word_active")}});$(".wk-head-search").on("input propertychange",function(){var J=$(".wk-head-search").val().split("+");var K=J[J.length-1];a(J,K);i()});function a(K,N){var O=$(".right_condition li span");var J=[];if(O.length){for(var L=0;L<O.length;L++){var P=O.eq(L).text();J[L]=P}K=J.concat(K)}for(var M=0;M<K.length-1;M++){if(N==K[M]){swal({title:"回测条件重复！",type:"warning",timer:1000,showConfirmButton:false});return false}}}function i(){var K=$(".wk-head-search").val();var M=u();if(K&&M){var L=K.split("+");var J;for(J in M){var N=M[J];if(Utility.inArray(N,L)){$(".index_recommend li[data-index='"+J+"']").addClass("word_active").attr("data-type","1")}else{$(".index_recommend li[data-index='"+J+"']").removeClass("word_active").attr("data-type","0")}}}}function u(){var M=$(".index_recommend li span,.left li span");var J=[];if(M.length){for(var L=0;L<M.length;L++){var N=M.eq(L).text();var K=M.eq(L).parent().data("index");J[K]=N}}return J}function y(){$(".index_time .testfrom").val(j);$(".index_time .testto").val(j);c("1","","16","detail-ul-basic");c("3","","16","detail-ul-tec");c("2","","16","detail-ul-industry");c("4","","16","detail-ul-news");c("5","","8","detail-ul-events");c("6","","8","detail-ul-hot")}function p(){c("1","","5","detail-ul-basic");c("3","","5","detail-ul-tec");c("2","","5","detail-ul-industry");c("4","","5","detail-ul-news");c("5","","5","detail-ul-events");c("6","","5","detail-ul-hot");$(".right_industry").append(common.getLoading());setTimeout(function(){l();s(0,10);x();$(".right_yield").removeClass("dis_none")},1000)}function s(M,N){var L=Utility.getUrlParam("session");var L=Utility.getUrlParam("session");if(L){var J=[];var K=[];backtest.backtestResult({session:L,pos:M,count:N},function(){if(F){$(".dataload").html("<div class=\"wk-user-no\"><i class='fa fa-refresh fa-spin'></i>&nbsp;正在加载...</div>")}},function(Q){if(!Q.body.end_time){if(b>=10){window.open(m,"_self")}else{setTimeout(function(){w=1;s();l();b++},1000)}}else{if(w){M=0;w=0}$(".right_content_title,.table-responsive,.dataload").removeClass("dis_none");$(".right_industry").append(common.hideLoading());var P=Q.body.stocks;r=r.concat(P);$(".testfrom").val(Q.body.start_time);$(".testto").val(Q.body.end_time);$(".right_stock_num span").html(Q.body.count);if(Q.body.right_sentence.length>0){var U=Q.body.right_sentence;for(var R=0;R<U.length;R++){if(U[R]["type"]&&U[R]["type"]==5){K.push("<li><span>"+U[R]["sentence"]+'</span><i class="fa tip_time"><div class="tip_abstract"><div class="title">事件摘要：</div>'+U[R]["abstract"]+'</div><div class="tip_date"><span class="title">开始时间：</span>'+Utility.unixToDate2(U[R]["start_time"])+'&nbsp;&nbsp;&nbsp;&nbsp;<span class="title">结束时间：</span>'+Utility.unixToDate2(U[R]["end_time"])+"</div></i></li>")}else{K.push("<li><span>"+U[R]["sentence"]+"</span></li>")}}K.push('<div class="clear"></div>');$(".right_condition ul").html(K.join(""))}if(Q.body.wrong_sentence.length){if(t==0){var T=[];var S=Q.body.wrong_sentence.join(" , ");T.push("<ul class='wrongsentence' style='text-align: center;margin:0 auto'>");for(var O=0;O<Q.body.wrong_sentence.length;O++){T.push("<li>"+Q.body.wrong_sentence[O]+"</li>")}T.push("<div class='clear'></div> </ul>");swal({title:"以下条件不符合筛选规则",type:"warning",text:S,timer:6500,showConfirmButton:false},function(){window.open(m,"_self")});$(".sweet-alert p").html(T.join("")).parent().css("width","555px");t=1}}if(Q.body.stocks.length){if(Q.body.stocks.length==Q.body.count){$(".right_resolve_data,.dataload").removeClass("dis_none");$(".dataload").addClass("dis_none")}for(var R=0;R<P.length;R++){J.push("<tr>");J.push("<td>"+(R+M+1)+"</td>");J.push('<td><input class="fl" type="checkbox" name="checkbox_name"/><a href="http://t.stock.iwookong.com/ajax/login/nologin.php?stock='+P[R].symbol+"&uid="+P[R].uid+"&token="+P[R].token+'" class="fl" target="_blank">'+P[R].symbol+"</a></td>");J.push("<td>"+P[R].name+"</a></td>");J.push('<td class="'+Utility.getPriceColor(P[R].changepercent)+'">'+P[R].trade+"</td>");J.push('<td class=" '+Utility.getPriceColor(P[R].changepercent)+'">'+P[R].changepercent.toFixed(2)+"%</td>");J.push("<td>"+(P[R].volume/10000).toFixed(2)+"万</td>");J.push("<td>"+P[R].amount.toFixed(2)+"</td>");J.push("<td>"+P[R].bordname+"</td></tr>");J.push("</tr>")}$(".right_industry_table tbody").append(J.join(""));$(".dataload").html('<div class="click_more">点击加载</div>');$("#table1 tbody").append(J.join(""));k=Utility.getUrlParam("session")}else{if(r.length){$(".right_resolve_data,.dataload").removeClass("dis_none");$(".dataload").addClass("dis_none")}else{$(".dataload").html("");$(".right_industry").html('<div style="width：100%;height:100px;line-height:100px;text-align:center"><img src="../../static/imgs/backtest/message.png" width="30px;">&nbsp;&nbsp;抱歉，没有选出相关的股票，请检查输入是否正确 </div>')}}}})}}function n(K){var L=K;var J=[];for(var M=0;M<L.length;M++){J.push("<tr>");J.push("<td>"+(M+1)+"</td>");J.push('<td><input class="fl" type="checkbox" name="checkbox_name"/><a href="http://t.stock.iwookong.com/ajax/login/nologin.php?stock='+L[M].symbol+"&uid="+L[M].uid+"&token="+L[M].token+'" class="fl" target="_blank">'+L[M].symbol+"</a></td>");J.push("<td>"+L[M].name+"</a></td>");J.push('<td class="'+Utility.getPriceColor(L[M].changepercent)+'">'+L[M].trade+"</td>");J.push('<td class=" '+Utility.getPriceColor(L[M].changepercent)+'">'+L[M].changepercent.toFixed(2)+"%</td>");J.push("<td>"+(L[M].volume/10000).toFixed(2)+"万</td>");J.push("<td>"+L[M].amount.toFixed(2)+"</td>");J.push("<td>"+L[M].bordname+"</td></tr>");J.push("</tr>")}$(".right_industry_table tbody").html(J.join(""));$("#checkedAll").prop("checked",false);$(".dataload").html('<div class="click_more">点击加载</div>');$("#table1 tbody").html(J.join(""))}function c(J,N,M,L){var K=[];backtest.getMoreSentence({flag:J,after_sentence:N,count:M},function(){$("."+L).append("<div class='sentence_load'><i class='fa fa-refresh fa-spin'></i>&nbsp;正在加载...</div>");$("."+L).next().hide()},function(O){if(O.head.status!=-103){if(O.body.sentences[0]){$("."+L).next().show();var Q=O.body.sentences[0][J];D[J]=D[J]+Q.length;for(var P=0;P<Q.length;P++){if(J==1){K.push('<li data-type="0" data-index="'+L+"-"+I+'"><span>'+Q[P].sentence+"</span></li>");I++}else{if(J==2){K.push('<li data-type="0" data-index="'+L+"-"+H+'"><span>'+Q[P].sentence+"</span></li>");H++}else{if(J==3){K.push('<li data-type="0" data-index="'+L+"-"+G+'"><span>'+Q[P].sentence+"</span></li>");G++}else{if(J==4){K.push('<li data-type="0" data-index="'+L+"-"+E+'"><span>'+Q[P].sentence+"</span></li>");E++}else{if(J==5){K.push('<li data-type="0" data-index="'+L+"-"+C+'"><span>'+Q[P].sentence+'</span><i class="fa tip_time"><div class="tip_abstract"><div class="title">事件摘要：</div>'+Q[P]["abstract"]+'</div><div class="tip_date"><span class="title">开始时间：</span>'+Utility.unixToDate2(Q[P].create_time)+'&nbsp;&nbsp;&nbsp;&nbsp;<span class="title">结束时间：</span>'+Utility.unixToDate2(Q[P].update)+"</div></i></li>");C++}else{if(J==6){K.push('<li data-type="0" data-index="'+L+"-"+B+'"><span>'+Q[P].sentence+"</span></li>");B++}}}}}}}$("."+L).find(".sentence_load").html("").removeClass("sentence_load");$("."+L).find(".clear").before(K.join(""));if(O.body.sentences[0]["totals"]==D[J]){$("."+L).next().css("visibility","hidden").attr("data-end",1)}}else{$("."+L).html("<div style='text-align:center'>暂无数据</div>")}}})}$(".detail_more").on("click",function(){var L=$(this);var K=L.attr("data-click-type");var N=L.prev().find("li").last().find("span").html();var J=L.prev().attr("class");var M=L.parent().find(".detail_title img").attr("data-sentecne");if(e=="result"){c(K,N,5,J)}else{if(M=="long"){c(K,N,8,J)}else{c(K,N,16,J)}}});function x(){$(window).scroll(function(){var M=$(this);var L=M.scrollTop();var K=$(document).height();var N=M.height();var J=K-L-N;if(J===0){f=f+10;s(f,10)}});$("body").on("click",".click_more",function(){f=f+10;s(f,10)})}function z(){var J=document.getElementById("export");J.addEventListener("click",function(K){K.preventDefault();tableExport("table1","回测平台",K.target.getAttribute("data-type"))},false)}var h="";$("body").on("click",".index_recommend li,.left li",function(){var L=$(this).attr("data-type");var M=$(this).find("span").html();var K=$(".wk-head-search").val();if(L==0){if(K==""){h=M}else{h=K+"+"+M}$(this).attr("data-type","1").addClass("word_active")}else{h=K;var J=h.split("+");J=$.grep(J,function(N){return N!=M});h=J.join("+");$(this).attr("data-type","0").removeClass("word_active");d=h}$(".wk-head-search").val(h);$(".wk-head-search").trigger("input")});$("body").on("click",".right thead td span",function(){var L;var K=$(this).attr("data-sort-type");var J=$(this).attr("data-hot-sort");if(K=="desc"){$(this).html("<img src='/static/imgs/i/icon_desc.png'>").attr("data-sort-type","ase").parent().siblings().find("span");L=r.sort(q(J))}else{$(this).html("<img src='/static/imgs/i/icon_asc.png'>").attr("data-sort-type","desc").parent().siblings().find("span");L=r.sort(A(J))}n(L)});var q=function(J){return function(N,M){var L,K;if(typeof N==="object"&&typeof M==="object"&&N&&M){L=N[J];K=M[J];if(L===K){return 0}if(typeof L===typeof K){return L>K?-1:1}return typeof L>typeof K?-1:1}else{throw ("error")}}};var A=function(J){return function(N,M){var L,K;if(typeof N==="object"&&typeof M==="object"&&N&&M){L=N[J];K=M[J];if(L===K){return 0}if(typeof L===typeof K){return L<K?-1:1}return typeof L<typeof K?-1:1}else{throw ("error")}}};$(".right .testfrom,.right .testto").on("focus",function(){var J=$(".right .testfrom").val();var K=$(".right .testto").val();$(".wk-header .testfrom").val(J);$(".wk-header .testto").val(K)});$("body").on("mouseover",".index-ul-hot li span,.result-ul-hot li span,.detail-ul-events li span,.right_condition li span",function(){$(this).next().show()});$("body").on("mouseout",".index-ul-hot li span,.result-ul-hot li span,.detail-ul-events li span,.right_condition li span",function(){$(this).next().hide()});$(window).scroll(function(){if($(window).scrollTop()>=200){$(".back_top").fadeIn(1000)}else{$(".back_top").fadeOut(200)}});$(".detail_title img,.left_content_title img").on("click",function(){var L=$(this);var J=L.attr("data-type");var M=L.attr("data-sentecne");var K=L.parent().parent().find(".detail_more").attr("data-end");if(J==1){L.parent().parent().find("ul li").show();if(K==0){L.parent().parent().find(".detail_more").css("visibility","visible")}L.attr({"data-type":0});L.css({transform:"rotate(360deg)","-ms-transform":"rotate(360deg)","-moz-transform":"rotate(360deg)","-webkit-transform":"rotate(360deg)","-o-transform":"rotate(360deg)"})}else{L.parent().parent().find("ul li").hide();L.parent().parent().find(".detail_more").css("visibility","hidden");if(e=="result"){if(M=="long"){L.parent().parent().find("ul li").slice(0,5).show()}else{L.parent().parent().find("ul li").slice(0,5).show()}}else{if(M=="long"){L.parent().parent().find("ul li").slice(0,8).show()}else{L.parent().parent().find("ul li").slice(0,16).show()}}L.attr({"data-type":1});L.css({transform:"rotate(180deg)","-ms-transform":"rotate(180deg)","-moz-transform":"rotate(180deg)","-webkit-transform":"rotate(180deg)","-o-transform":"rotate(180deg)"})}});$("#checkedAll").click(function(){if($(this).prop("checked")==true){$(".right_industry input[name='checkbox_name']").each(function(){$(this).prop("checked",true)})}else{$(".right_industry input[name='checkbox_name']").each(function(){$(this).prop("checked",false)})}});$(".result_set_group").on("click",function(){var K=[];var J=0;$(".right_industry input[name='checkbox_name']:checked").each(function(){K[J]=$(this).parent().find("a").html();J++});if(K.length==0){swal({title:"请选择模拟的股票",type:"warning",timer:1200,showConfirmButton:false});return false}swal({title:"添加组合",text:"组合名称不能超过6个汉字或12个字符",type:"input",html:true,showCancelButton:true,closeOnConfirm:false,confirmButtonText:"确定",cancelButtonText:"取消",animation:"slide-from-top",inputPlaceholder:"请输入组合名称"},function(L){if(L===false){return false}if(L===""){swal.showInputError("请输入组合名称");return false}if(Utility.getByteLen(L)>12){swal.showInputError("字符数超过限制");return false}trade.getUserRelatedOp({opcode:101,group_name:L,code_list:K.join(",")},null,function(M){if(M.group_id){swal({title:"",text:"添加<span style='color: #F8BB86'>"+L+"</span>组合成功",html:true,timer:1000,showConfirmButton:false})}else{swal({title:"",text:"添加<span style='color: #F8BB86'>"+L+"</span>组合异常,"+M.msg+"",html:true,timer:1000,showConfirmButton:false})}})})});if(e=="result"){p();z()}else{y()}});