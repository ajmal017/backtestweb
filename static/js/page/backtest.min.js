"use strict";$(function(){var m="http://"+window.location.host+"/";var e=$(".wk-content").attr("data-type");var f=0;var d="";var o=0;var s=0;var D;var q=[];var k;var v;var b=0;var B=[];B[1]=0;B[3]=0;B[2]=0;B[4]=0;B[5]=0;B[6]=0;var G=0;var F=0;var E=0;var C=0;var A=0;var z=0;var u=Date.parse(new Date())-24*3600*1000;var j=Utility.unixToDate2(u);var g=Utility.unixToDate3(u);$(".wk-head-search").typeahead({minLength:1,maxItem:20,order:"asc",hint:true,group:true,maxItemPerGroup:null,backdrop:false,dynamic:true,filter:false,emptyTemplate:'未找到 "{{query}}" 的相关信息',display:["sentence"],source:{"热点事件":{ajax:{url:m+"ajax/backtest/ajax_search.php",data:{message:"{{query}}"},path:"events"}},"基本面":{ajax:{url:m+"ajax/backtest/ajax_search.php",data:{message:"{{query}}"},path:"basic"}},"技术面":{ajax:{url:m+"ajax/backtest/ajax_search.php",data:{message:"{{query}}"},path:"technology"}},"消息面":{ajax:{url:m+"ajax/backtest/ajax_search.php",data:{message:"{{query}}"},path:"news"}},"行为热度面":{ajax:{url:m+"ajax/backtest/ajax_search.php",data:{message:"{{query}}"},path:"hot"}}},callback:{onResult:function(){var I=$(".wk-head-search").val();var H=I.split("+");backtest.searchCheck({message:I},null,function(J){if(J.checked_sentences){if(J.checked_sentences.length!=H.length){$(".typeahead__result").css("display"," block")}else{$(".typeahead__result").css("display"," none")}}if(J.status){var M=J.checked_sentences;var L=0;for(var K=0;K<M.length;K++){if(19000<=M[K]["id"]&&M[K]["id"]<20000){L=1}}if(L){$(".index_time .testfrom,.index_time .testto").val(g);$(".testfrom,.testto").attr("onFocus","WdatePicker({lang:'zh-cn',dateFmt:'yyyy-MM-dd-HH',maxDate:'time_h'})")}else{$(".index_time .testfrom,.index_time .testto").val(j);$(".testfrom,.testto").attr("onFocus","WdatePicker({lang:'zh-cn',dateFmt:'yyyy-MM-dd',maxDate:new Date()})")}}d=I})},onClick:function(K,I,J){var H=$(".wk-head-search").val().split("+");H[H.length-1]=J.sentence;d=H.join("+");a(H,J.sentence)},onClickAfter:function(){$(".wk-head-search").val(d);i()},onSubmit:function(J,I,N,H){var O=$(".index_time .testfrom").val();var M=$(".index_time .testto").val();var P=$(".wk-head-search").val();var K;var L;backtest.searchCheck({message:P},null,function(Q){if(Q.status==1){K=Q.checked_sentences;if(O&&M){if(e!="result"){k=-1}if(k){backtest.backtest({search:JSON.stringify(K),base_sessionid:k,start_time:O,end_time:M},null,function(R){L=R.body.bt_session})}else{swal({title:"无筛选结果 ",type:"warning",timer:800,showConfirmButton:false})}}else{swal({title:"请选择回测时间",type:"warning",timer:800,showConfirmButton:false});$(".clock_time").trigger("click")}}else{if(Q.result){swal({title:"搜索关键字为空 ",type:"warning",timer:600,showConfirmButton:false})}else{swal({title:"请输入正确的的回测关键词",type:"warning",timer:800,showConfirmButton:false})}}});setTimeout(function(){if(L){window.open(m+"backtest/result.php?session="+L,"_blank")}},500);return false}}});function l(){var I=Utility.getUrlParam("session");var H=echarts.init(document.getElementById("wk-rate-line-pic"));backtest.getRateLine({sessionid:I},function(){$(".right_yield").hide()},function(J){if(J.body){if(J.body.list.length!=0){$(".right_yield").show()}common.buildRateLine("成分股","",J);H.hideLoading();D=1}else{D=0}})}$(".clock_time").on("click",function(){var H=$(".index_time").css("display");if(H=="block"){$(".index_time").hide()}else{$(".index_time").show()}$(document).bind("click",function(J){var I=$(J.target);if(I.closest(".typeahead__container").length==0){$(".index_time").hide()}})});$(".wk-head-search").mousemove(function(){var H=$(".typeahead__container").hasClass("cancel");if(!H){o=1}var I=$(".wk-head-search").val();if(!I){$(".index_recommend li").attr("data-type","0").removeClass("word_active")}});$(".wk-head-search").on("input propertychange",function(){var H=$(".wk-head-search").val().split("+");var I=H[H.length-1];a(H,I);i()});function a(I,L){var M=$(".right_condition li span");var H=[];if(M.length){for(var J=0;J<M.length;J++){var N=M.eq(J).text();H[J]=N}I=H.concat(I)}for(var K=0;K<I.length-1;K++){if(L==I[K]){swal({title:"回测条件重复！",type:"warning",timer:1000,showConfirmButton:false});return false}}}function i(){var I=$(".wk-head-search").val();var K=t();if(I&&K){var J=I.split("+");var H;for(H in K){var L=K[H];if(Utility.inArray(L,J)){$(".index_recommend li[data-index='"+H+"']").addClass("word_active").attr("data-type","1")}else{$(".index_recommend li[data-index='"+H+"']").removeClass("word_active").attr("data-type","0")}}}}function t(){var K=$(".index_recommend li span,.left li span");var H=[];if(K.length){for(var J=0;J<K.length;J++){var L=K.eq(J).text();var I=K.eq(J).parent().data("index");H[I]=L}}return H}function x(){$(".index_time .testfrom").val(j);$(".index_time .testto").val(j);c("1","","16","detail-ul-basic");c("3","","16","detail-ul-tec");c("2","","16","detail-ul-industry");c("4","","16","detail-ul-news");c("5","","8","detail-ul-events");c("6","","8","detail-ul-hot")}function p(){c("1","","5","detail-ul-basic");c("3","","5","detail-ul-tec");c("2","","5","detail-ul-industry");c("4","","5","detail-ul-news");c("5","","5","detail-ul-events");c("6","","5","detail-ul-hot");$(".right_industry").append(common.getLoading());setTimeout(function(){l();r(0,10);w();$(".right_yield").removeClass("dis_none")},1000)}function r(K,L){var J=Utility.getUrlParam("session");var J=Utility.getUrlParam("session");if(J){var H=[];var I=[];backtest.backtestResult({session:J,pos:K,count:L},function(){if(D){$(".dataload").html("<div class=\"wk-user-no\"><i class='fa fa-refresh fa-spin'></i>&nbsp;正在加载...</div>")}},function(O){if(!O.body.end_time){if(b>=10){window.open(m,"_self")}else{setTimeout(function(){v=1;r();l();b++},1000)}}else{if(v){K=0;v=0}$(".right_content_title,.table-responsive,.dataload").removeClass("dis_none");$(".right_industry").append(common.hideLoading());var N=O.body.stocks;q=q.concat(N);$(".testfrom").val(O.body.start_time);$(".testto").val(O.body.end_time);$(".right_stock_num span").html(O.body.count);if(O.body.right_sentence.length>0){var S=O.body.right_sentence;for(var P=0;P<S.length;P++){if(S[P]["type"]&&S[P]["type"]==5){I.push("<li><span>"+S[P]["sentence"]+'</span><i class="fa tip_time"><div class="tip_abstract"><div class="title">事件摘要：</div>'+S[P]["abstract"]+'</div><div class="tip_date"><span class="title">开始时间：</span>'+Utility.unixToDate2(S[P]["start_time"])+'&nbsp;&nbsp;&nbsp;&nbsp;<span class="title">结束时间：</span>'+Utility.unixToDate2(S[P]["end_time"])+"</div></i></li>")}else{I.push("<li><span>"+S[P]["sentence"]+"</span></li>")}}I.push('<div class="clear"></div>');$(".right_condition ul").html(I.join(""))}if(O.body.wrong_sentence.length){if(s==0){var R=[];var Q=O.body.wrong_sentence.join(" , ");R.push("<ul class='wrongsentence' style='text-align: center;margin:0 auto'>");for(var M=0;M<O.body.wrong_sentence.length;M++){R.push("<li>"+O.body.wrong_sentence[M]+"</li>")}R.push("<div class='clear'></div> </ul>");swal({title:"以下条件不符合筛选规则",type:"warning",text:Q,timer:6500,showConfirmButton:false},function(){window.open(m,"_self")});$(".sweet-alert p").html(R.join("")).parent().css("width","555px");s=1}}if(O.body.stocks.length){if(O.body.stocks.length==O.body.count){$(".right_resolve_data,.dataload").removeClass("dis_none");$(".dataload").addClass("dis_none")}for(var P=0;P<N.length;P++){H.push("<tr>");H.push("<td>"+(P+K+1)+"</td>");H.push('<td><input class="fl" type="checkbox" name="checkbox_name"/><a href="http://stock.iwookong.com/ajax/login/nologin.php?stock='+N[P].symbol+"&uid="+N[P].uid+"&token="+N[P].token+'" class="fl" target="_blank">'+N[P].symbol+"</a></td>");H.push("<td>"+N[P].name+"</a></td>");H.push('<td class="'+Utility.getPriceColor(N[P].changepercent)+'">'+N[P].trade.toFixed(2)+"</td>");H.push('<td class=" '+Utility.getPriceColor(N[P].changepercent)+'">'+N[P].changepercent.toFixed(2)+"%</td>");H.push("<td>"+(N[P].volume/10000).toFixed(2)+"万</td>");H.push("<td>"+(N[P].amount*100).toFixed(2)+"%</td>");H.push("<td>"+N[P].bordname+"</td></tr>");H.push("</tr>")}$(".right_industry_table tbody").append(H.join(""));$(".dataload").html('<div class="click_more">点击加载</div>');$("#table1 tbody").append(H.join(""));k=Utility.getUrlParam("session")}else{if(q.length){$(".right_resolve_data,.dataload").removeClass("dis_none");$(".dataload").addClass("dis_none")}else{$(".dataload").html("");$(".right_industry").html('<div style="width：100%;height:100px;line-height:100px;text-align:center"><img src="../../static/imgs/backtest/message.png" width="30px;">&nbsp;&nbsp;抱歉，没有选出相关的股票，请检查输入是否正确 </div>')}}}})}}function n(I){var J=I;var H=[];for(var K=0;K<J.length;K++){H.push("<tr>");H.push("<td>"+(K+1)+"</td>");H.push('<td><input class="fl" type="checkbox" name="checkbox_name"/><a href="http://stock.iwookong.com/ajax/login/nologin.php?stock='+J[K].symbol+"&uid="+J[K].uid+"&token="+J[K].token+'" class="fl" target="_blank">'+J[K].symbol+"</a></td>");H.push("<td>"+J[K].name+"</a></td>");H.push('<td class="'+Utility.getPriceColor(J[K].changepercent)+'">'+J[K].trade+"</td>");H.push('<td class=" '+Utility.getPriceColor(J[K].changepercent)+'">'+J[K].changepercent.toFixed(2)+"%</td>");H.push("<td>"+(J[K].volume/10000).toFixed(2)+"万</td>");H.push("<td>"+J[K].amount.toFixed(2)+"</td>");H.push("<td>"+J[K].bordname+"</td></tr>");H.push("</tr>")}$(".right_industry_table tbody").html(H.join(""));$("#checkedAll").prop("checked",false);$(".dataload").html('<div class="click_more">点击加载</div>');$("#table1 tbody").html(H.join(""))}function c(H,L,K,J){var I=[];backtest.getMoreSentence({flag:H,after_sentence:L,count:K},function(){$("."+J).append("<div class='sentence_load'><i class='fa fa-refresh fa-spin'></i>&nbsp;正在加载...</div>");$("."+J).next().hide()},function(M){if(M.head.status!=-103){if(M.body.sentences[0]){$("."+J).next().show();var O=M.body.sentences[0][H];B[H]=B[H]+O.length;for(var N=0;N<O.length;N++){if(H==1){I.push('<li data-type="0" data-index="'+J+"-"+G+'"><span>'+O[N].sentence+"</span></li>");G++}else{if(H==2){I.push('<li data-type="0" data-index="'+J+"-"+F+'"><span>'+O[N].sentence+"</span></li>");F++}else{if(H==3){I.push('<li data-type="0" data-index="'+J+"-"+E+'"><span>'+O[N].sentence+"</span></li>");E++}else{if(H==4){I.push('<li data-type="0" data-index="'+J+"-"+C+'"><span>'+O[N].sentence+"</span></li>");C++}else{if(H==5){I.push('<li data-type="0" data-index="'+J+"-"+A+'"><span>'+O[N].sentence+'</span><i class="fa tip_time"><div class="tip_abstract"><div class="title">事件摘要：</div>'+O[N]["abstract"]+'</div><div class="tip_date"><span class="title">开始时间：</span>'+Utility.unixToDate2(O[N].create_time)+'&nbsp;&nbsp;&nbsp;&nbsp;<span class="title">结束时间：</span>'+Utility.unixToDate2(O[N].update)+"</div></i></li>");A++}else{if(H==6){I.push('<li data-type="0" data-index="'+J+"-"+z+'"><span>'+O[N].sentence+"</span></li>");z++}}}}}}}$("."+J).find(".sentence_load").html("").removeClass("sentence_load");$("."+J).find(".clear").before(I.join(""));if(M.body.sentences[0]["totals"]==B[H]){$("."+J).next().css("visibility","hidden").attr("data-end",1)}}else{$("."+J).html("<div style='text-align:center'>暂无数据</div>")}}})}$(".detail_more").on("click",function(){var J=$(this);var I=J.attr("data-click-type");var L=J.prev().find("li").last().find("span").html();var H=J.prev().attr("class");var K=J.parent().find(".detail_title img").attr("data-sentecne");if(e=="result"){c(I,L,5,H)}else{if(K=="long"){c(I,L,8,H)}else{c(I,L,16,H)}}});function w(){$(window).scroll(function(){var K=$(this);var J=K.scrollTop();var I=$(document).height();var L=K.height();var H=I-J-L;if(H===0){f=f+10;r(f,10)}});$("body").on("click",".click_more",function(){f=f+10;r(f,10)})}function y(){var H=document.getElementById("export");H.addEventListener("click",function(I){I.preventDefault();tableExport("table1","回测平台",I.target.getAttribute("data-type"))},false)}var h="";$("body").on("click",".index_recommend li,.left li",function(){var J=$(this).attr("data-type");var K=$(this).find("span").html();var I=$(".wk-head-search").val();if(J==0){if(I==""){h=K}else{h=I+"+"+K}$(this).attr("data-type","1").addClass("word_active")}else{h=I;var H=h.split("+");H=$.grep(H,function(L){return L!=K});h=H.join("+");$(this).attr("data-type","0").removeClass("word_active");d=h}$(".wk-head-search").val(h);$(".wk-head-search").trigger("input")});$("body").on("click",".right thead td span",function(){var J;var I=$(this).attr("data-sort-type");var H=$(this).attr("data-hot-sort");if(I=="desc"){$(this).html("<img src='/static/imgs/i/icon_desc.png'>").attr("data-sort-type","ase").parent().siblings().find("span");J=q.sort(Utility.desc_by(H))}else{$(this).html("<img src='/static/imgs/i/icon_asc.png'>").attr("data-sort-type","desc").parent().siblings().find("span");J=q.sort(Utility.asc_by(H))}n(J)});$(".right .testfrom,.right .testto").on("focus",function(){var H=$(".right .testfrom").val();var I=$(".right .testto").val();$(".wk-header .testfrom").val(H);$(".wk-header .testto").val(I)});$("body").on("mouseover",".index-ul-hot li span,.result-ul-hot li span,.detail-ul-events li span,.right_condition li span",function(){$(this).next().show()});$("body").on("mouseout",".index-ul-hot li span,.result-ul-hot li span,.detail-ul-events li span,.right_condition li span",function(){$(this).next().hide()});$(window).scroll(function(){if($(window).scrollTop()>=200){$(".back_top").fadeIn(1000)}else{$(".back_top").fadeOut(200)}});$(".detail_title img,.left_content_title img").on("click",function(){var J=$(this);var H=J.attr("data-type");var K=J.attr("data-sentecne");var I=J.parent().parent().find(".detail_more").attr("data-end");if(H==1){J.parent().parent().find("ul li").show();if(I==0){J.parent().parent().find(".detail_more").css("visibility","visible")}J.attr({"data-type":0});J.css({transform:"rotate(360deg)","-ms-transform":"rotate(360deg)","-moz-transform":"rotate(360deg)","-webkit-transform":"rotate(360deg)","-o-transform":"rotate(360deg)"})}else{J.parent().parent().find("ul li").hide();J.parent().parent().find(".detail_more").css("visibility","hidden");if(e=="result"){if(K=="long"){J.parent().parent().find("ul li").slice(0,5).show()}else{J.parent().parent().find("ul li").slice(0,5).show()}}else{if(K=="long"){J.parent().parent().find("ul li").slice(0,8).show()}else{J.parent().parent().find("ul li").slice(0,16).show()}}J.attr({"data-type":1});J.css({transform:"rotate(180deg)","-ms-transform":"rotate(180deg)","-moz-transform":"rotate(180deg)","-webkit-transform":"rotate(180deg)","-o-transform":"rotate(180deg)"})}});$("#checkedAll").click(function(){Utility.allcheckOrNot("#checkedAll",".right_industry")});$(".result_set_group").on("click",function(){var I=[];var H=0;$(".right_industry input[name='checkbox_name']:checked").each(function(){I[H]=$(this).parent().find("a").html();H++});if(I.length==0){swal({title:"请选择模拟的股票",type:"warning",timer:1200,showConfirmButton:false});return false}swal({title:"添加关注",text:"关注名称不能超过6个汉字或12个字符",type:"input",html:true,showCancelButton:true,closeOnConfirm:false,confirmButtonText:"确定",cancelButtonText:"取消",animation:"slide-from-top",inputPlaceholder:"请输入关注名称"},function(J){$(".sa-input-error").click(function(){$(this).removeClass("show").prev().val("");$(this).parent().parent().find(".sa-error-container").removeClass("show")});if(J===false){return false}if(J===""){swal.showInputError("请输入关注名称");return false}if(Utility.getByteLen(J)>12){swal.showInputError("字符数超过限制");return false}trade.getUserRelatedOp({opcode:120,attention_name:encodeURI(J+","),code_list:I.join(",")},null,function(K){if(K.status==0){swal({title:"",text:"添加<span style='color: #F8BB86'>"+J+"</span>关注成功",html:true,timer:1000,showConfirmButton:false})}else{swal({title:"",text:"添加<span style='color: #F8BB86'>"+J+"</span>关注异常："+K.msg+"",html:true,timer:1000,showConfirmButton:false})}})})});if(e=="result"){p();y()}else{x()}});