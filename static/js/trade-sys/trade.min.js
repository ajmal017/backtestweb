"use strict";$(function(){var f;var h;var i;var g;var k=0;var c="http://"+window.location.host+"/";$(".wk-trade-search").typeahead({minLength:2,maxItem:20,order:"asc",hint:true,group:true,maxItemPerGroup:5,backdrop:false,dynamic:true,filter:false,emptyTemplate:'未找到 "{{query}}" 的相关信息',source:{"股票":{url:[c+"ajax/trade/ajax_search.php?message={{query}},&type=1","stock"]}},callback:{onClickAfter:function(){var n=$(".wk-trade-search").val();var m=n.substring(n.indexOf("(")+1,n.indexOf(")"));var l=$("#buy .trade-info .user-group option:selected").val();if(l==-1){swal({title:"请先选择账户名",type:"warning",timer:1200,showConfirmButton:false});$("#buy .wk-trade-search").val("");return false}j(m);e("#buy",m);$("#buy .buy-wrong").hide().attr("data-wrong-type",-1);$("#buy .user-group").on("change",function(){j(m)})}}});$(".trade-reset").click(function(){var l=$(this);l.parent().find(".trade-info li input").val("");l.parent().find(".trade-info li .num-scale  input").prop("checked",false);l.parent().find(".trade-info li>span").html("");l.parent().find(".trade-info li .buy-wrong").hide().attr("data-wrong-type",-1);l.parent().find(".trade-info li .buy-price,.trade-info li .buy-num").attr("readonly","readonly");l.parent().find(".trade-info li .num-scale input").attr("disabled",true);l.parent().find(".trade-info .user-group option").eq(0).prop("selected",true);l.parent().find(".trade-info li .sale-stock").html("").append('<option value="-1">请选择</option>')});$(".buy-price,.buy-num").change(function(){var n=$(this).parent().parent();var o=parseFloat(n.find("li .now-num").html());var l=parseFloat(n.find("li .buy-price").val());var m=parseInt(n.find("li .buy-num").val());if(l){var p=l.toString().split(".")[1];if(l==0||l<g||l>i){$(this).parent().find(".buy-wrong").show().attr("data-wrong-type",1)}else{if(p&&p.length>2){$(this).parent().find(".buy-wrong").show().attr("data-wrong-type",1)}else{$(this).parent().find(".buy-wrong").hide().attr("data-wrong-type",-1)}}}else{$(this).parent().find(".buy-wrong").show().attr("data-wrong-type",1)}if(m&&o){if(m==0||m>o||m%100!=0){n.find(".num .buy-wrong").show().attr("data-wrong-type",1)}else{n.find(".num .buy-wrong").hide().attr("data-wrong-type",-1)}}else{n.find(".num .buy-wrong").show().attr("data-wrong-type",1)}n.find(".num-scale input").attr("disabled",true);if(o>=100&&o<200){n.find(".num-scale input:nth-child(1)").attr("disabled",false)}else{if(o>=200&&o<300){n.find(".num-scale input:nth-child(1),.num-scale input:nth-child(2)").attr("disabled",false)}else{if(o>=300&&o<400){n.find(".num-scale input:nth-child(1),num-scale input:nth-child(2),.num-scale input:nth-child(3)").attr("disabled",false)}else{if(o>=400&&o<500){n.find(".num-scale input:nth-child(1),.num-scale input:nth-child(2),.num-scale input:nth-child(3),.num-scale input:nth-child(4)").attr("disabled",false)}else{if(o>=500){n.find(".num-scale input").attr("disabled",false)}}}}}if(!l||!m){n.find(".buy-total").html("")}else{n.find(".buy-total").html((l*m).toFixed(2))}});$(".num-scale input").click(function(){var l=$(this).parent().parent().parent();var n=parseFloat($(this).attr("data-scale"));if(n==0.33){n=1/3}var m=parseFloat(l.find("li .now-num").html());var o=parseInt(m*n).toString().slice(-2);if(n==1||(m*n)%100==0){m=parseInt(m*n)}else{m=parseInt(m*n)-Number(o)}l.find("li .buy-num").val(m);$(this).parent().parent().find(".buy-num").trigger("change")});function a(){trade.getUserRelatedOp({opcode:104},null,function(p){if(p.status==0){var m=[];var q=p.group_list;for(var o=0;o<q.length;o++){m.push('<option value ="'+q[o].id+'">'+q[o].name+"</option>")}$(".user-group").append(m.join(""));var l=Utility.getUrlParam("code");var n=Utility.getUrlParam("gid");var r=Utility.getUrlParam("name");var s=Utility.getUrlParam("type");if(l){if(s){$("#trade .nav li:nth-child(1)").removeClass("active").find("a").attr("aria-expanded","false");$("#trade .nav li:nth-child(2)").addClass("active").find("a").attr("aria-expanded","true");$("#trade .tab-content #buy").removeClass("active");$("#trade .tab-content #sale").addClass("active");$("#sale .user-group option").each(function(){if($(this).attr("value")==n){$(this).prop("selected",true).siblings().prop("selected",false);$("#sale .sale-stock-group").trigger("change",[l])}})}else{$("#buy .wk-trade-search").val(r+"("+l+")");e("#buy",l);$("#buy .buy-wrong").hide().attr("data-wrong-type",-1);$("#buy .user-group").on("change",function(){j(l)});if(n){$("#buy .user-group option").each(function(){if($(this).attr("value")==n){$(this).prop("selected",true).siblings().prop("selected",false);j(l)}})}}}}})}function e(l,m){trade.getStockInfo({code:m},null,function(r){console.log(r);if(r.status==1){var t=r.real_info.now_price;var q=r.buy;var s=r.sell;var n=r.real_info;var p=$(l+" .buy-num").val();f=q[0];h=s[0];i=n.limit_up.toFixed(2);g=n.limit_down.toFixed(2);for(var o=0;o<5;o++){$(l+" .table2 tr").eq(o).find("td").eq(1).html(s[4-o].price.toFixed(2)).addClass(Utility.getPriceColor(s[4-o].price-t));$(l+" .table2 tr").eq(o).find("td").eq(2).html(parseInt(s[4-o].vol));$(l+" .table2 tr").eq(6+o).find("td").eq(1).html(q[o].price.toFixed(2)).addClass(Utility.getPriceColor(q[o].price-t));$(l+" .table2 tr").eq(6+o).find("td").eq(2).html(parseInt(q[o].vol))}$(l+" .table2 tr").eq(5).find("td").eq(1).html(t.toFixed(2)).addClass(Utility.getPriceColor(t-n.yesterday_close_price));$(l+" .table1 tr").eq(0).find("td span").html(n.now_price.toFixed(2)).addClass(Utility.getPriceColor(n.now_price-t));$(l+" .table1 tr").eq(1).find("td span").html(n.open_price.toFixed(2)).addClass(Utility.getPriceColor(n.open_price-t));$(l+" .table1 tr").eq(2).find("td span").html(n.yesterday_close_price.toFixed(2));$(l+" .table1 tr").eq(3).find("td span").html(n.high_price.toFixed(2)).addClass(Utility.getPriceColor(n.high_price-t));$(l+" .table1 tr").eq(4).find("td span").html(n.low_price.toFixed(2)).addClass(Utility.getPriceColor(n.low_price-t));$(l+" .table1 tr").eq(5).find("td span").html(n.limit_up.toFixed(2)).addClass(Utility.getPriceColor(n.limit_up-t));$(l+" .table1 tr").eq(6).find("td span").html(n.limit_down.toFixed(2)).addClass(Utility.getPriceColor(n.limit_down-t));if(n.turnover_rate>1){$(l+" .table1 tr").eq(7).find("td span").html("--")}else{$(l+" .table1 tr").eq(7).find("td span").html((n.turnover_rate*100).toFixed(2)+"%")}$(l+" .table1 tr").eq(8).find("td span").html(parseInt(n.vol));$(l+" .now-price").html((n.now_price).toFixed(2));if(l=="#buy"){$(l+" .buy-price").val((s[0].price).toFixed(2));$(l+" .buy-total").html((s[0].price*p).toFixed(2))}else{if(l=="#sale"){$(l+" .buy-price").val((q[0].price).toFixed(2));$(l+" .buy-total").html((q[0].price*p).toFixed(2))}}$(l+" .right-infos").show();$(l+" .buy-price").removeAttr("readonly")}})}$(".sale-stock-group").change(function(o,p){var n=$(this).find("option:selected").val();var l=Utility.getUrlParam("code");if(n!=="-1"){var m=[];trade.getUserRelatedOp({gid:n,opcode:112},null,function(r){if(r.status==0){var s=r.stock_list;m.push('<option value="-1">请选择</option>');for(var q=0;q<s.length;q++){m.push('<option value ="'+s[q].code+'" data-name="'+s[q].name+'" data-num="'+s[q].available+'">'+s[q].name+"("+s[q].code+")</option>")}$("#sale .sale-stock").html(m.join(""));$("#sale .sale-stock option").each(function(){if($(this).attr("value")==l){$(this).prop("selected",true).siblings().prop("selected",false);$("#sale .sale-stock").trigger("change")}})}})}});$(".sale-stock").change(function(){var p=$(this).find("option:selected");var o=p.val();var m=p.attr("data-name");var n=p.attr("data-price");var l=p.attr("data-num");if(o!=="0"){$("#sale .buy-num").removeAttr("readonly");$("#sale .num-scale input").eq(0).prop("checked",true);$("#sale .stock-name").html(m);$("#sale .stock-code").html(o);$("#sale .now-num").html(l);$("#sale .buy-num").val(l);e("#sale",o);if(l>=100&&l<200){$("#sale .num-scale input:nth-child(1)").attr("disabled",false)}else{if(l>=200&&l<300){$("#sale .num-scale input:nth-child(1),#sale .num-scale input:nth-child(2)").attr("disabled",false)}else{if(l>=300&&l<400){$("#sale .num-scale input:nth-child(1),#sale .num-scale input:nth-child(2),#sale .num-scale input:nth-child(3)").attr("disabled",false)}else{if(l>=400&&l<500){$("#sale .num-scale input:nth-child(1),#sale .num-scale input:nth-child(2),#sale .num-scale input:nth-child(3),#sale .num-scale input:nth-child(4)").attr("disabled",false)}else{if(l>=500){$("#sale .num-scale input").attr("disabled",false)}}}}}}$("#sale .buy-wrong").hide().attr("data-wrong-type",-1)});$(".trade-btn").click(function(){var n=$(this).attr("data-type");var s=$(this).parent().find(".trade-info .user-group option:selected").val();var m=$(this).parent().find(".stock-name").html();var u=$(this).parent().find(".stock-code").html();var t=Number($(this).parent().find("li .buy-price").val()).toFixed(2);var o=Number($(this).parent().find(".stop-price input").val()).toFixed(2);var q=$(this).parent().find("li .buy-num").val();var p=$(this).parent().find(".price .buy-wrong").attr("data-wrong-type");var l=$(this).parent().find(".num .buy-wrong").attr("data-wrong-type");if(o=="NaN"){o="0.00"}if(s==-1){swal({title:"请选择账户名",type:"warning",timer:1200,showConfirmButton:false});return false}if(t*q==0){swal({title:"交易总金额不可以为0！",type:"warning",timer:1200,showConfirmButton:false});return false}if(!t||!q){swal({title:"输入信息不正确，请补全信息",type:"warning",timer:1200,showConfirmButton:false});return false}if(p=="-1"&&l=="-1"){var r="";if(n==0){r="买入"}else{if(n==1){r="卖出"}}swal({title:"委托"+r,text:"确定以"+t+"的价格"+r+q+"股 "+m+"("+u+")?",type:"info",html:true,showCancelButton:true,closeOnConfirm:false,confirmButtonText:"确定",cancelButtonText:"取消",animation:"slide-from-top"},function(){trade.getUserRelatedOp({opcode:111,gid:s,code:u+",",order_price:t,expected_price:o,order_nums:q,order_operation:n},null,function(v){if(v.status==0||v.status==24||v.status==25){if(n==0){swal({title:v.msg,type:"success",timer:1200,showConfirmButton:false});$("#buy .now-num").html(v.canbuy_num);$("#buy .available-capital").html(v.available_capital)}else{if(n==1){swal({title:v.msg,type:"success",timer:1200,showConfirmButton:false});$("#sale .now-num").html(v.cansell_num)}}Utility.setCookie("last_gid",s);d()}else{swal({title:v.msg,type:"error",timer:1200,showConfirmButton:false})}})})}else{swal({title:"输入信息有误，请重新输入",type:"warning",timer:1200,showConfirmButton:false})}});function d(){trade.getUserRelatedOp({opcode:107,gid:0},function(){if(k==0){$(".day_orders table tbody").html("<tr><td colspan='9'><i class='fa fa-refresh fa-spin'></i>&nbsp;正在加载...</td></tr>")}},function(m){if(m.status==0){var o=[];var n=m.order_list;if(n.length!==0){for(var l=0;l<n.length;l++){o.push("<tr>");o.push("<td>"+(l+1)+"</td>");o.push("<td>"+n[l].group_name+"</td>");o.push('<td><a href="http://stock.iwookong.com/ajax/login/nologin.php?stock='+n[l].code+"&uid="+uid+'&token=token" target="_blank">'+n[l].name+"("+n[l].code+")</a></td>");if(n[l].order_operation){o.push("<td>卖出</td>")}else{o.push("<td>买入</td>")}o.push("<td>"+n[l].order_price.toFixed(2)+"</td>");o.push("<td>"+n[l].order_nums+"</td>");o.push("<td>"+Utility.unixToDate4(n[l].order_time*1000)+"</td>");if(n[l].status==1){o.push("<td>已成交</td>");o.push("<td>--</td>")}else{if(n[l].status==0){o.push("<td>未成交</td>");o.push('<td class="call-back" data-order-id="'+n[l].id+'" data-gid="'+n[l].group_id+'">撤销</td>')}else{if(n[l].status==2){o.push("<td>已撤销</td>");o.push("<td>--</td>")}}}o.push("</tr>")}}else{o.push('<tr><td colspan="8">暂无数据</td></tr>')}$(".day_orders table tbody").html(o.join(""));k++}})}$("body").on("click","#trade .call-back",function(){var m=$(this).attr("data-order-id");var l=$(this).attr("data-gid");swal({title:"",text:"确认要撤销这笔委托么？",type:"info",html:true,showCancelButton:true,closeOnConfirm:false,confirmButtonText:"确定",cancelButtonText:"取消",animation:"slide-from-top"},function(){trade.getUserRelatedOp({opcode:114,order_id:m,gid:l},null,function(n){if(n.status==0){swal({title:"撤单成功！",type:"success",timer:1200,showConfirmButton:false});d()}else{swal({title:"撤单失败！",type:"error",timer:1200,showConfirmButton:false})}})})});function j(p){var n=$("#buy .trade-info .user-group option:selected").val();var l=Utility.getUrlParam("gid");var o=Utility.getUrlParam("price");var m=$("#buy .buy-price").val();if(l){n=l}trade.getUserRelatedOp({opcode:113,code:p,gid:n},null,function(q){if(q.status==0){$("#buy .stock-name").html(q.name);$("#buy .stock-code").html(q.code);$("#buy .now-num").html(q.count);$("#buy .buy-num").val(q.count);$("#buy .available-capital").html(q.available_capital);$("#buy .right-infos").show();$("#buy .num-scale input").eq(0).prop("checked",true);if(m){$("#buy .buy-total").html((m*q.count).toFixed(2))}else{if(o){$("#buy .buy-total").html((o*q.count).toFixed(2))}}$("#buy .num-scale input").attr("disabled",true);if(q.count>=100&&q.count<200){$("#buy .num-scale input:nth-child(1)").attr("disabled",false)}else{if(q.count>=200&&q.count<300){$("#buy .num-scale input:nth-child(1),#buy .num-scale input:nth-child(2)").attr("disabled",false)}else{if(q.count>=300&&q.count<400){$("#buy .num-scale input:nth-child(1),#buy .num-scale input:nth-child(2),#buy .num-scale input:nth-child(3)").attr("disabled",false)}else{if(q.count>=400&&q.count<500){$("#buy .num-scale input:nth-child(1),#buy .num-scale input:nth-child(2),#buy .num-scale input:nth-child(3),#buy .num-scale input:nth-child(4)").attr("disabled",false)}else{if(q.count>=500){$("#buy .num-scale input").attr("disabled",false)}}}}}if(q.count!=0){$("#buy .buy-num").removeAttr("readonly")}}})}function b(){a();d()}b()});