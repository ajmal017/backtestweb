"use strict";$(function(){var b="http://"+window.location.host+"/";var g;var k;$(".wk-attention-search").typeahead({minLength:2,maxItem:20,order:"asc",hint:true,group:true,maxItemPerGroup:5,backdrop:false,dynamic:true,filter:false,emptyTemplate:'未找到 "{{query}}" 的相关信息',source:{"股票":{url:[b+"ajax/trade/ajax_search.php?message={{query}},&type=1","stock"]}},callback:{onClickAfter:function(){var m=$(".wk-attention-search").val();var l=m.substring(m.indexOf("(")+1,m.indexOf(")"));if(g&&l){trade.getUserRelatedOp({opcode:124,attention_id:g,code_list:l+","},null,function(n){if(n.status==0){$(".wk-attention-search").val("");i(g)}})}}}});function a(){trade.getUserRelatedOp({opcode:123},function(){$(".group-name-list").html('<li style="border:none"><i class="fa fa-refresh fa-spin"></i>&nbsp;加载中...</li>')},function(m){if(m.status==0){var l=[];if(m.attention_list.length>0){for(var n=0;n<m.attention_list.length;n++){if(n==0){g=m.attention_list[0].id;l.push('<li class="left gp-active" data-gid="'+m.attention_list[0].id+'">')}else{l.push('<li class="left" data-gid="'+m.attention_list[n].id+'">')}l.push("<span>"+m.attention_list[n].name+"</span>&nbsp;");l.push('<span class="dropdown-toggle" data-toggle="dropdown"><i class="fa fa-chevron-down"></i></span>');l.push('<ul class="dropdown-menu" data-group-name="'+m.attention_list[n].name+'" data-group-id="'+m.attention_list[n].id+'"><li class="change-name"><a href="#"><i class="fa fa-pencil fa-fw"></i>更改名称</a></li><li class="del-group"><a href="#"><i class="fa fa-trash-o fa-fw"></i>删除组合</a></li></ul>');l.push("</li>")}}l.push('<li class="left add-group trade-add-group" data-gid="-1">自定义<i class="fa fa-plus"></i></li>');l.push('<div class="clear"></div>');$(".group-name-list").html(l.join(""));if(g){h();i(g);c();d()}else{$(".group-stock-list table tbody").html('<tr><td colspan="10">暂无组合相关的股票信息</td></tr>')}}})}$("body").on("click","#attention .add-group",function(){swal({title:"添加账户",text:"账户名称不能超过6个汉字或12个字符",type:"input",html:true,showCancelButton:true,closeOnConfirm:false,confirmButtonText:"确定",cancelButtonText:"取消",animation:"slide-from-top",inputPlaceholder:"请输入账户名称"},function(l){$(".sa-input-error").click(function(){$(this).removeClass("show").prev().val("");$(this).parent().parent().find(".sa-error-container").removeClass("show")});if(l===false){return false}if($.trim(l)===""){swal.showInputError("请输入账户名称");return false}if(Utility.getByteLen(l)>12){swal.showInputError("字符数超过限制");return false}trade.getUserRelatedOp({opcode:120,attention_name:encodeURIComponent(l+","),code_list:","},null,function(m){if(m.status==0){swal({title:"",text:"添加<span style='color: #F8BB86'>"+l+"</span>账户成功",html:true,timer:1000,showConfirmButton:false});a()}else{swal({title:"",text:"添加<span style='color: #F8BB86'>"+l+"</span>账户异常,"+m.msg+"",html:true,timer:1000,showConfirmButton:false})}})})});function h(){$("#attention .group-name-list >li").on("click",function(){$(this).not(".add-group").addClass("gp-active").siblings().removeClass("gp-active");var l=$(this).attr("data-gid");if(l!=-1){g=l;i(l)}})}function i(){trade.getUserRelatedOp({opcode:126,attention_id:g},function(){$(".group-stock-list table tbody").html('<tr><td colspan="10"><i class="fa fa-refresh fa-spin"></i>&nbsp;加载中...</td></tr>')},function(m){if(m.status==0){var l=[];var o=m.stock_list;k=m.stock_list;if(o.length>0){for(var n=0;n<o.length;n++){l.push("<tr>");l.push("<td>"+(n+1)+"</td>");l.push('<td><input type="checkbox" class="left"><span class="left">'+o[n].code+"</span></td>");l.push("<td>"+o[n].name+"</td>");l.push("<td>"+o[n].visit_heat+"</td>");l.push('<td class="'+Utility.getPriceColor(o[n].change)+'">'+o[n].price.toFixed(2)+"</td>");l.push('<td class="'+Utility.getPriceColor(o[n].change)+'">'+o[n].change.toFixed(2)+"%"+Utility.getHotUpDown(o[n].change)+"</td>");l.push("<td>"+(o[n].volume/10000).toFixed(2)+"</td>");l.push("<td>"+o[n].industry+"</td>");l.push("<td>");l.push('<a href="trade.php?name='+o[n].name+"&code="+o[n].code+"&price="+o[n].price.toFixed(2)+'"><img src="../static/imgs/trade/op_buy.png" class="one-stock-trade" data-trade-type="0"></a>&nbsp;');l.push("</td>");l.push('<td><i class="fa fa-minus-circle text-danger btn-del-stock" data-stock-code="'+o[n].code+'" data-stock-gid="'+g+'"></i></td>');l.push("</tr>")}}else{l.push('<tr><td colspan="10">暂无关注的股票</td></tr>')}$(".group-stock-list table tbody").html(l.join(""));$(".bulk-trade-op").attr("data-capital",m.available_capital);f()}})}function e(n){if(n.length>0){var l=[];for(var m=0;m<n.length;m++){l.push("<tr>");l.push("<td>"+(m+1)+"</td>");l.push('<td><input type="checkbox" class="left"><span class="left">'+n[m].code+"</span></td>");l.push("<td>"+n[m].name+"</td>");l.push("<td>"+n[m].visit_heat+"</td>");l.push('<td class="'+Utility.getPriceColor(n[m].change)+'">'+n[m].price.toFixed(2)+"</td>");l.push('<td class="'+Utility.getPriceColor(n[m].change)+'">'+n[m].change.toFixed(2)+"%"+Utility.getHotUpDown(n[m].change)+"</td>");l.push("<td>"+(n[m].volume/10000).toFixed(2)+"</td>");l.push("<td>"+n[m].industry+"</td>");l.push("<td>");l.push('<a href="trade.php?name='+n[m].name+"&code="+n[m].code+"&price="+n[m].price.toFixed(2)+'"><img src="../static/imgs/trade/op_buy.png" class="one-stock-trade" data-trade-type="0"></a>&nbsp;');l.push("</td>");l.push('<td><i class="fa fa-minus-circle text-danger btn-del-stock" data-stock-code="'+n[m].code+'" data-stock-gid="'+g+'"></i></td>');l.push("</tr>")}$(".group-stock-list table tbody").html(l.join(""))}}function f(){$(".group-stock-list table tr").hover(function(){var l=$(this).find("td:nth-child(3)").html();$(this).find(".btn-del-stock").show().bind("click",function(){var o=$(this).attr("data-stock-code");var m=$(this).attr("data-stock-gid");if(!o){var n=0;m=g;$(".group-stock-list tbody input[type='checkbox']:checked").each(function(){if(n==0){o=$(this).parent().find("span").html()}else{o=o+","+$(this).parent().find("span").html()}n++})}if(o&&m){swal({title:"",text:"确定删除<span style='color: #F8BB86'>"+l+"("+o+")</span>吗?此操作将无法恢复!",type:"warning",html:true,showCancelButton:true,confirmButtonColor:"#DD6B55",confirmButtonText:"确定",cancelButtonText:"取消",closeOnConfirm:false,closeOnCancel:true},function(p){if(p){trade.getUserRelatedOp({opcode:125,code_list:o+",",attention_id:m},null,function(q){if(q.status==0){swal({title:"",text:"<span style='color:#F8BB86'>"+l+"("+o+")</span>已被删除",html:true,timer:1000,showConfirmButton:false});i()}})}})}else{if(!o){swal({title:"请选择需要批量删除的股票",type:"warning",timer:1200,showConfirmButton:false})}}})},function(){$(this).find(".btn-del-stock").hide()})}$(".bulk-trade-btn").click(function(){var n=$(this).parent().find(".modal-trade-num input").val();var m;var p;var l=$(this).attr("data-trade-type");var r=0;var q=$("#attention .bulk-trade-op").attr("data-capital");var o=0;$(".group-stock-list tbody input[type='checkbox']:checked").each(function(){var s=$(this).parent().find("span").html();var u=$(this).parent().parent().find("td:nth-child(5)").html();var t=$(this).parent().parent().find("td:nth-child(9) img:nth-child(2)").attr("data-holding-num");if(o==0){m=s;p=u}else{m=m+","+s;p=p+","+u}r=r+u*n;o++});if(m&&p&&q&&Number(n)!=0){if(l==0){if(q-r<0){swal({title:"剩余可买资金不足！",type:"warning",timer:1200,showConfirmButton:false});return false}}trade.getUserRelatedOp({opcode:131,gid:g,code_list:m+",",order_price:p+",",expected_price:"0.00",order_nums:n*100,order_operation:l},null,function(s){if(s.fail_List.length==0&&s.success_list.length!=0){if(l==0){swal({title:"买入成功！",type:"success",timer:2000,showConfirmButton:false})}else{if(l==1){swal({title:"卖出成功！",type:"success",timer:2000,showConfirmButton:false})}}i()}else{var u="";var v="";for(var t=0;t<s.success_list.length;t++){if(t==0){u+=s.success_list[t].name+"("+s.success_list[t].code+")"}else{u+=","+s.success_list[t].name+"("+s.success_list[t].code+")"}}for(var t=0;t<s.fail_List.length;t++){if(t==0){v+=s.fail_List[t].name+"("+s.fail_List[t].code+")"}else{v+=","+s.fail_List[t].name+"("+s.fail_List[t].code+")"}}if(s.success_list.length==0){swal({title:"",text:"交易全部失败:<span style='color:#F8BB86'>"+v+"</span>",html:true,showConfirmButton:true})}else{swal({title:"",text:"交易成功的股票：<span style='color:#F8BB86'>"+u+"</span>,交易失败:<span style='color:#F8BB86'>"+v+"</span>",html:true,showConfirmButton:true})}i()}})}else{if(!m){swal({title:"请选择模拟的股票",type:"warning",timer:1200,showConfirmButton:false})}else{if(Number(n)==0){swal({title:"请输入交易的数量",type:"warning",timer:1200,showConfirmButton:false});return false}else{if(!q){swal({title:"获取初始资金失败",type:"error",timer:1200,showConfirmButton:false})}}}}});function c(){$("#attention .change-name").on("click",function(){var l=$(this).parent().attr("data-group-id");var m=$(this).parent().attr("data-group-name");swal({title:"更改名称【"+m+"】",text:"组合名称不能超过6个汉字或12个字符",type:"input",html:true,showCancelButton:true,closeOnConfirm:false,confirmButtonText:"确定",cancelButtonText:"取消",animation:"slide-from-top",inputPlaceholder:"请输入组合名称"},function(n){$(".sa-input-error").click(function(){$(this).removeClass("show").prev().val("");$(this).parent().parent().find(".sa-error-container").removeClass("show")});if(n===false){return false}if($.trim(n)===""){swal.showInputError("请输入组合名称");return false}if($.trim(n)==m){swal.showInputError("与原组合名重复");return false}if(Utility.getByteLen(n)>12){swal.showInputError("字符数超过限制");return false}trade.getUserRelatedOp({opcode:121,attention_name:encodeURIComponent(n+","),attention_id:l},null,function(o){if(o.status==0){swal({title:"",text:"修改组合<span style='color: #F8BB86'>"+m+"</span>为<span style='color: #F8BB86'>"+n+"</span>成功",html:true,timer:1000,showConfirmButton:false});a()}else{swal({title:"",text:"修改组合<span style='color: #F8BB86'>"+m+"</span>为<span style='color: #F8BB86'>"+n+"</span>失败："+o.msg,html:true,timer:1500,showConfirmButton:false})}})})})}function d(){$("#attention .del-group").on("click",function(){var l=$(this).parent().attr("data-group-id");var m=$(this).parent().attr("data-group-name");swal({title:"",text:"确定删除<span style='color: #F8BB86'>"+m+"</span>吗?此操作将无法恢复!",type:"warning",html:true,showCancelButton:true,confirmButtonColor:"#DD6B55",confirmButtonText:"确定",cancelButtonText:"取消",closeOnConfirm:false,closeOnCancel:true},function(n){if(n){trade.getUserRelatedOp({opcode:122,attention_id:l},null,function(o){if(o.status==0){swal({title:"",text:"组合<span style='color: #F8BB86'>"+m+"</span>已被删除",html:true,timer:1000,showConfirmButton:false});a()}})}})})}function j(){trade.getUserRelatedOp({opcode:116,gid:13},null,function(l){if(l.status==0){return l.capital}})}$("#attention .checkedAll").click(function(){Utility.allcheckOrNot($(this),"#attention .group-stock-list")});$("body").on("click","#attention .group-stock-list td .sort_img",function(){var n;var m=$(this).attr("data-sort-type");var l=$(this).attr("data-hot-sort");if(m=="desc"){$(this).attr({src:"/static/imgs/trade/arrow_up.png","data-sort-type":"ase"}).parent().siblings().find(".sort_img").attr("src","/static/imgs/trade/arrow_down.png");n=k.sort(Utility.asc_by(l))}else{$(this).attr({src:"/static/imgs/trade/arrow_down.png","data-sort-type":"desc"});n=k.sort(Utility.desc_by(l))}e(n)});a()});